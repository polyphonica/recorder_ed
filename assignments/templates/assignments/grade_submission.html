{% extends 'base.html' %}
{% load static %}

{% block title %}Grade Submission - {{ submission.assignment.title }}{% endblock %}

{% block extra_css %}
<style>
    #notation-display, #reference-notation-display {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        min-height: 150px;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-6xl">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold mb-2">Grade Submission</h1>
                <p class="text-base-content/70">{{ submission.assignment.title }}</p>
            </div>
            <a href="{% url 'assignments:teacher_submissions' %}" class="btn btn-outline">
                <i class="fas fa-arrow-left mr-2"></i>Back to Submissions
            </a>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content (Left) - 2/3 width -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Assignment Details Card -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-clipboard mr-2"></i>Assignment Details
                    </h2>

                    <!-- Student Info -->
                    <div class="bg-base-200 rounded-lg p-4 mb-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm text-base-content/70">Student</div>
                                <div class="text-xl font-bold">
                                    {% if assignment_link.lesson.lesson_request.child_profile %}
                                        {{ assignment_link.lesson.lesson_request.child_profile.full_name }}
                                    {% else %}
                                        {{ submission.student.get_full_name|default:submission.student.username }}
                                    {% endif %}
                                </div>
                                {% if assignment_link.lesson.lesson_request.child_profile %}
                                    <div class="text-xs text-base-content/60">
                                        Guardian: {{ submission.student.get_full_name|default:submission.student.username }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="text-right">
                                <div class="text-sm text-base-content/70">Submitted</div>
                                <div class="font-semibold">
                                    {{ submission.submitted_at|date:"M j, Y - g:i A" }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Assignment Title and Instructions -->
                    <div class="mb-4">
                        <h3 class="font-bold text-lg mb-2">{{ submission.assignment.title }}</h3>
                        <p class="text-base-content/70 whitespace-pre-wrap">{{ submission.assignment.instructions }}</p>
                    </div>

                    <!-- Assignment Type Badges -->
                    <div class="flex gap-2">
                        {% if submission.assignment.has_notation_component %}
                            <span class="badge badge-primary">
                                <i class="fas fa-music mr-1"></i>Notation Component
                            </span>
                        {% endif %}
                        {% if submission.assignment.has_written_component %}
                            <span class="badge badge-secondary">
                                <i class="fas fa-pen mr-1"></i>Written Component
                            </span>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Student's Notation Work -->
            {% if submission.assignment.has_notation_component %}
                <div class="card card-section shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-4">
                            <i class="fas fa-music mr-2"></i>Notation Submission
                        </h2>

                        {% if submission.notation_data %}
                            <div id="notation-display"></div>
                        {% else %}
                            <div class="alert alert-warning">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Student did not submit any notation work</span>
                            </div>
                        {% endif %}

                        <!-- Reference Notation (if provided) -->
                        {% if submission.assignment.reference_notation %}
                            <div class="divider">Reference Notation</div>
                            <div id="reference-notation-display" class="bg-base-200 rounded-lg p-4"></div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Student's Written Response -->
            {% if submission.assignment.has_written_component %}
                <div class="card card-section shadow-xl">
                    <div class="card-body">
                        <h2 class="card-title text-2xl mb-4">
                            <i class="fas fa-pen mr-2"></i>Written Response
                        </h2>

                        <div class="font-semibold mb-2">Student's Response:</div>
                        <div class="bg-white rounded-lg p-3 border border-base-300">
                            {% if submission.written_response %}
                                <div class="ck-content">{{ submission.written_response|safe }}</div>
                            {% else %}
                                <em class="text-base-content/50">No response provided</em>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>

        <!-- Grading Panel (Right) - 1/3 width -->
        <div class="lg:col-span-1">
            <div class="card card-section shadow-xl sticky top-4">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-check-circle mr-2"></i>{% if submission.status == 'graded' %}Update Grade{% else %}Assign Grade{% endif %}
                    </h2>

                    {% if submission.status == 'graded' %}
                        <div class="alert alert-success mb-4">
                            <i class="fas fa-info-circle"></i>
                            <div>
                                <div class="font-semibold">Currently Graded</div>
                                <div class="text-sm">Grade: {{ submission.get_formatted_grade }}</div>
                                <div class="text-sm">Graded on: {{ submission.graded_at|date:"M j, Y" }}</div>
                            </div>
                        </div>
                    {% endif %}

                    <form method="post">
                        {% csrf_token %}

                        <!-- Grade Input -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text font-semibold text-lg">{{ form.grade.label }}</span>
                                <span class="label-text-alt text-error">*Required</span>
                            </label>
                            {{ form.grade }}
                            {% if form.grade.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.grade.errors.0 }}</span>
                                </label>
                            {% endif %}
                            {% if form.grade.help_text %}
                                <label class="label">
                                    <span class="label-text-alt">{{ form.grade.help_text }}</span>
                                </label>
                            {% endif %}
                        </div>

                        <!-- Feedback Input -->
                        <div class="form-control mb-6">
                            <label class="label">
                                <span class="label-text font-semibold text-lg">{{ form.feedback.label }}</span>
                                <span class="label-text-alt">Optional</span>
                            </label>
                            {{ form.feedback }}
                            {% if form.feedback.errors %}
                                <label class="label">
                                    <span class="label-text-alt text-error">{{ form.feedback.errors.0 }}</span>
                                </label>
                            {% endif %}
                            <label class="label">
                                <span class="label-text-alt">Provide constructive feedback to help the student improve</span>
                            </label>
                        </div>

                        <!-- Form Actions -->
                        <div class="divider"></div>
                        <div class="flex flex-col gap-2">
                            <button type="submit" class="btn btn-primary w-full">
                                <i class="fas fa-save mr-2"></i>{% if submission.status == 'graded' %}Update Grade{% else %}Submit Grade{% endif %}
                            </button>
                            <a href="{% url 'assignments:teacher_submissions' %}" class="btn btn-outline w-full">
                                Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

{% if submission.assignment.has_notation_component %}
<script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const VF = Vex.Flow;

    // Convert barline type from our format to VexFlow numeric format
    function convertBarlineType(type) {
        const typeMap = {
            'SINGLE': 1,
            'DOUBLE': 2,
            'END': 3,
            'REPEAT_BEGIN': 4,
            'REPEAT_END': 5,
            'REPEAT_BOTH': 6
        };
        return typeMap[type] || 1;
    }

    // Render student's notation submission
    {% if submission.notation_data %}
    const studentNotationData = {{ submission.notation_data|safe }};
    renderNotation('notation-display', studentNotationData);
    {% endif %}

    // Render reference notation if available
    {% if submission.assignment.reference_notation %}
    const referenceNotationData = {{ submission.assignment.reference_notation|safe }};
    renderNotation('reference-notation-display', referenceNotationData);
    {% endif %}

    function renderNotation(containerId, notationData) {
        const container = document.getElementById(containerId);
        if (!container || !notationData) {
            return;
        }

        // Clear container
        container.innerHTML = '';

        // Check if this is multi-stave format
        if (notationData.staves && Array.isArray(notationData.staves)) {
            // Multi-stave format
            renderMultiStave(container, notationData.staves);
            return;
        }

        // Single stave format (backward compatibility)
        renderSingleStaveOld(container, notationData);
    }

    function renderMultiStave(container, staves) {
        // Calculate height needed for all staves (200px per stave)
        const totalHeight = staves.length * 200;

        const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
        renderer.resize(700, totalHeight);
        const context = renderer.getContext();

        // Render each stave
        staves.forEach((staveData, index) => {
            const yPosition = 40 + (index * 200);
            try {
                renderSingleStave(context, staveData, yPosition);
            } catch (error) {
                console.error(`Error rendering stave ${index + 1}:`, error);
            }
        });
    }

    function renderSingleStave(context, staveData, yPosition) {
        const stave = new VF.Stave(10, yPosition, 680);
        const clef = staveData.clef || 'treble';
        const keySignature = staveData.keySignature || '';
        const timeSignature = staveData.timeSignature || '4/4';

        stave.addClef(clef);
        if (keySignature) {
            stave.addKeySignature(keySignature);
        }
        if (timeSignature) {
            stave.addTimeSignature(timeSignature);
        }
        stave.setContext(context).draw();

        // If there are no notes, just show the empty stave
        if (!staveData.notes || staveData.notes.length === 0) {
            return;
        }

        const vfNotes = staveData.notes.map(noteData => {
            if (noteData.type === 'barline') {
                const barlineType = noteData.barlineType || 'SINGLE';
                return new VF.BarNote(convertBarlineType(barlineType));
            } else {
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration,
                    clef: clef
                });

                // Apply automatic stem direction
                const isRest = noteData.duration.includes('r');
                if (!isRest) {
                    const middleLines = {
                        'treble': { note: 'b', octave: 4 },
                        'bass': { note: 'd', octave: 3 },
                        'alto': { note: 'c', octave: 4 }
                    };

                    const getNotePitchValue = (key) => {
                        const [noteName, octave] = key.split('/');
                        const noteValues = { 'c': 0, 'd': 1, 'e': 2, 'f': 3, 'g': 4, 'a': 5, 'b': 6 };
                        return parseInt(octave) * 7 + noteValues[noteName.toLowerCase()];
                    };

                    const middleLine = middleLines[clef] || middleLines['treble'];
                    const middleLinePitch = middleLine.octave * 7 +
                        { 'c': 0, 'd': 1, 'e': 2, 'f': 3, 'g': 4, 'a': 5, 'b': 6 }[middleLine.note];

                    const pitchValues = noteData.keys.map(getNotePitchValue);
                    const avgPitch = pitchValues.reduce((a, b) => a + b, 0) / pitchValues.length;

                    if (avgPitch >= middleLinePitch) {
                        note.setStemDirection(VF.Stem.DOWN);
                    } else {
                        note.setStemDirection(VF.Stem.UP);
                    }
                }

                if (noteData.accidental) {
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                }

                if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        }).filter(note => note !== null && note !== undefined);

        if (vfNotes.length === 0) return;

        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 650);
        voice.draw(context, stave);
    }

    function renderSingleStaveOld(container, notationData) {
        // Old single-stave rendering for backward compatibility
        const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
        renderer.resize(700, 200);
        const context = renderer.getContext();

        const stave = new VF.Stave(10, 40, 680);
        const clef = notationData.clef || 'treble';
        const keySignature = notationData.keySignature || '';

        stave.addClef(clef);
        if (keySignature) {
            stave.addKeySignature(keySignature);
        }
        stave.setContext(context).draw();

        // If there are no notes, just show the empty stave
        if (!notationData.notes || notationData.notes.length === 0) {
            return;
        }

        // Create notes
        const vfNotes = notationData.notes.map(noteData => {
            if (noteData.type === 'barline') {
                return new VF.BarNote();
            } else {
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration,
                    clef: clef
                });

                // Apply automatic stem direction based on standard notation rules (skip for rests)
                const isRest = noteData.duration.includes('r');
                if (!isRest) {
                    const middleLines = {
                        'treble': { note: 'b', octave: 4 },  // B4 is middle line in treble
                        'bass': { note: 'd', octave: 3 },    // D3 is middle line in bass
                        'alto': { note: 'c', octave: 4 }     // C4 is middle line in alto
                    };

                    const getNotePitchValue = (key) => {
                        const [noteName, octave] = key.split('/');
                        const noteValues = { 'c': 0, 'd': 1, 'e': 2, 'f': 3, 'g': 4, 'a': 5, 'b': 6 };
                        return parseInt(octave) * 7 + noteValues[noteName.toLowerCase()];
                    };

                    const middleLine = middleLines[clef] || middleLines['treble'];
                    const middleLinePitch = middleLine.octave * 7 +
                        { 'c': 0, 'd': 1, 'e': 2, 'f': 3, 'g': 4, 'a': 5, 'b': 6 }[middleLine.note];

                    // For chords, use the average position
                    const pitchValues = noteData.keys.map(getNotePitchValue);
                    const avgPitch = pitchValues.reduce((a, b) => a + b, 0) / pitchValues.length;

                    // Standard rule: notes on or above middle line get stems down
                    if (avgPitch >= middleLinePitch) {
                        note.setStemDirection(VF.Stem.DOWN);
                    } else {
                        note.setStemDirection(VF.Stem.UP);
                    }
                }

                // Handle single note accidentals
                if (noteData.accidental) {
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                }

                // Handle chord accidentals
                if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        });

        // Create voice and format
        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);  // Don't strictly enforce beat counting
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 650);

        // Draw voice
        voice.draw(context, stave);
    }
});
</script>
{% endif %}
{% endblock %}
