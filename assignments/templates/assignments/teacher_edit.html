{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Assignment - {{ assignment.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'assignments:teacher_library' %}"
               class="text-blue-600 hover:text-blue-800 hover:underline mb-4 inline-flex items-center gap-2 text-base font-medium">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
                </svg>
                Back to Library
            </a>
            <h1 class="text-5xl font-bold text-gray-900 mt-4">Edit Assignment</h1>
            <p class="text-lg text-gray-600 mt-2">Update your assignment - {{ assignment.title }}</p>
        </div>

        <!-- Form -->
        <form method="post" id="assignment-form" class="space-y-8">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1.5 h-8 bg-blue-600 rounded-full"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Basic Information</h2>
                </div>

                <div class="space-y-6">
                    <!-- Title -->
                    <div>
                        <label for="{{ form.title.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                            {{ form.title.label }} <span class="text-red-600 text-lg">*</span>
                        </label>
                        {{ form.title }}
                        {% if form.title.help_text %}
                        <p class="mt-2 text-sm text-gray-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.title.help_text }}
                        </p>
                        {% endif %}
                        {% if form.title.errors %}
                        <p class="mt-2 text-sm font-medium text-red-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.title.errors.0 }}
                        </p>
                        {% endif %}
                    </div>

                    <!-- Instructions -->
                    <div>
                        <label for="{{ form.instructions.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                            {{ form.instructions.label }} <span class="text-red-600 text-lg">*</span>
                        </label>
                        {{ form.instructions }}
                        {% if form.instructions.help_text %}
                        <p class="mt-2 text-sm text-gray-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.instructions.help_text }}
                        </p>
                        {% endif %}
                        {% if form.instructions.errors %}
                        <p class="mt-2 text-sm font-medium text-red-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.instructions.errors.0 }}
                        </p>
                        {% endif %}
                    </div>

                    <!-- Grading Scale -->
                    <div>
                        <label for="{{ form.grading_scale.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                            {{ form.grading_scale.label }} <span class="text-red-600 text-lg">*</span>
                        </label>
                        {{ form.grading_scale }}
                        {% if form.grading_scale.help_text %}
                        <p class="mt-2 text-sm text-gray-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.grading_scale.help_text }}
                        </p>
                        {% endif %}
                        {% if form.grading_scale.errors %}
                        <p class="mt-2 text-sm font-medium text-red-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.grading_scale.errors.0 }}
                        </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Categorization & Visibility -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1.5 h-8 bg-purple-600 rounded-full"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Categorization & Visibility</h2>
                </div>

                <div class="space-y-6">
                    <!-- Difficulty -->
                    <div>
                        <label for="{{ form.difficulty.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                            {{ form.difficulty.label }}
                        </label>
                        {{ form.difficulty }}
                        {% if form.difficulty.help_text %}
                        <p class="mt-2 text-sm text-gray-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            {{ form.difficulty.help_text }}
                        </p>
                        {% endif %}
                        {% if form.difficulty.errors %}
                        <p class="mt-2 text-sm font-medium text-red-600">{{ form.difficulty.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Existing Tags -->
                    <div>
                        <label for="{{ form.tags.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                            {{ form.tags.label }}
                        </label>
                        {{ form.tags }}
                        {% if form.tags.help_text %}
                        <p class="mt-2 text-sm text-gray-600 flex items-center gap-1">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                            </svg>
                            Hold Ctrl (Cmd on Mac) to select multiple tags
                        </p>
                        {% endif %}
                        {% if form.tags.errors %}
                        <p class="mt-2 text-sm font-medium text-red-600">{{ form.tags.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Create New Tags -->
                    <div class="border-2 border-gray-200 rounded-xl overflow-hidden">
                        <input type="checkbox" id="new-tags-toggle" class="peer sr-only" />
                        <label for="new-tags-toggle" class="flex items-center justify-between p-4 bg-gray-50 cursor-pointer hover:bg-gray-100 transition-colors">
                            <span class="font-semibold text-gray-900 flex items-center gap-2">
                                <svg class="w-5 h-5 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd"/>
                                </svg>
                                Or Create New Tags
                            </span>
                            <svg class="w-5 h-5 text-gray-600 transition-transform peer-checked:rotate-180" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </label>
                        <div class="hidden peer-checked:block p-6 space-y-6 bg-white border-t-2 border-gray-200">
                            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg">
                                <p class="text-sm text-blue-800 flex items-start gap-2">
                                    <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Create new tags by entering them below, separated by commas. They will be automatically added to this assignment and saved for future use.</span>
                                </p>
                            </div>

                            <div>
                                <label for="{{ form.new_tags.id_for_label }}" class="block text-base font-semibold text-gray-900 mb-3">
                                    {{ form.new_tags.label }}
                                </label>
                                {{ form.new_tags }}
                                {% if form.new_tags.help_text %}
                                <p class="mt-2 text-sm text-gray-600">{{ form.new_tags.help_text }}</p>
                                {% endif %}
                            </div>

                            <div class="bg-green-50 border-l-4 border-green-500 p-4 rounded-r-lg">
                                <p class="text-sm text-green-800 flex items-start gap-2">
                                    <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                                    </svg>
                                    <span>Example: "Scales, Rhythm, Theory" will create three tags and add them all to this assignment.</span>
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Make Public -->
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                        <label class="flex items-start gap-3 cursor-pointer">
                            {{ form.is_public }}
                            <span class="flex-1">
                                <span class="block text-base font-semibold text-gray-900">{{ form.is_public.label }}</span>
                                {% if form.is_public.help_text %}
                                <span class="block text-sm text-gray-600 mt-1">{{ form.is_public.help_text }}</span>
                                {% endif %}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Assignment Components -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1.5 h-8 bg-orange-600 rounded-full"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Assignment Components</h2>
                </div>

                <div class="space-y-4">
                    <!-- Notation Component -->
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                        <label class="flex items-start gap-3 cursor-pointer">
                            {{ form.has_notation_component }}
                            <span class="flex-1">
                                <span class="block text-base font-semibold text-gray-900">{{ form.has_notation_component.label }}</span>
                                {% if form.has_notation_component.help_text %}
                                <span class="block text-sm text-gray-600 mt-1">{{ form.has_notation_component.help_text }}</span>
                                {% endif %}
                            </span>
                        </label>
                    </div>

                    <!-- Written Component -->
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                        <label class="flex items-start gap-3 cursor-pointer">
                            {{ form.has_written_component }}
                            <span class="flex-1">
                                <span class="block text-base font-semibold text-gray-900">{{ form.has_written_component.label }}</span>
                                {% if form.has_written_component.help_text %}
                                <span class="block text-sm text-gray-600 mt-1">{{ form.has_written_component.help_text }}</span>
                                {% endif %}
                            </span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Reference Notation -->
            <div class="bg-white rounded-xl shadow-lg p-8 border border-gray-200">
                <div class="flex items-center gap-3 mb-6">
                    <div class="w-1.5 h-8 bg-green-600 rounded-full"></div>
                    <h2 class="text-2xl font-bold text-gray-900">Reference/Example (Optional)</h2>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6">
                    <p class="text-sm text-blue-800 flex items-start gap-2">
                        <svg class="w-5 h-5 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                        </svg>
                        <span>Create reference notation visually using the notation editor. Students will see this as an example when completing the assignment.</span>
                    </p>
                </div>

                <!-- Notation Editor Button -->
                <div class="mb-6">
                    <button type="button" onclick="openNotationEditor()" class="inline-flex items-center gap-2 px-6 py-4 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-semibold text-base shadow-md hover:shadow-lg">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
                        </svg>
                        <span id="editor-button-text">Open Notation Editor</span>
                    </button>
                </div>

                <!-- Notation Preview -->
                <div id="notation-preview-container" style="display: none;">
                    <label class="block text-base font-semibold text-gray-900 mb-3">Preview</label>
                    <div id="notation-preview" class="border-2 border-gray-200 rounded-lg p-6 bg-white min-h-[150px] mb-4"></div>
                    <button type="button" onclick="clearNotationData()" class="inline-flex items-center gap-2 px-4 py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors font-medium text-sm">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"/>
                        </svg>
                        Clear Notation
                    </button>
                </div>

                <!-- Hidden input for notation data -->
                <input type="hidden" name="reference_notation" id="id_reference_notation" value="">
            </div>

            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-4 pt-4">
                <button type="submit" class="flex-1 sm:flex-initial bg-blue-600 text-white px-10 py-4 rounded-xl hover:bg-blue-700 active:bg-blue-800 transition-all font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 inline-flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Save Changes
                </button>
                <a href="{% url 'assignments:teacher_library' %}"
                   class="flex-1 sm:flex-initial bg-gray-200 text-gray-800 px-10 py-4 rounded-xl hover:bg-gray-300 active:bg-gray-400 transition-all font-bold text-lg text-center shadow-md hover:shadow-lg">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Notation Editor Modal -->
<div id="notation-editor-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-7xl w-full max-h-[90vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 px-8 py-6 flex items-center justify-between rounded-t-2xl">
            <h2 class="text-3xl font-bold text-gray-900">Music Notation Editor</h2>
            <button type="button" onclick="closeNotationEditor()" class="text-gray-500 hover:text-gray-700 transition-colors">
                <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                </svg>
            </button>
        </div>

        <div class="p-8">
            <!-- Instructions -->
            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg mb-6">
                <h3 class="font-bold text-blue-900 mb-2">How to Use:</h3>
                <ul class="text-sm text-blue-800 space-y-1 list-disc list-inside">
                    <li>Select clef, duration, and pitch to add notes</li>
                    <li>Use accidentals (‚ôØ, ‚ô≠, ‚ôÆ) before adding notes</li>
                    <li>Enable "Chord Mode" to add multiple notes at once</li>
                    <li>Add rests and barlines as needed</li>
                    <li>Click "Save Notation" when finished</li>
                </ul>
            </div>

            <!-- Toolbar Row 1: Clef and Duration -->
            <div class="flex flex-wrap gap-4 mb-4 p-4 bg-gray-50 rounded-lg">
                <!-- Clef Selection -->
                <div class="flex items-center gap-2">
                    <span class="font-semibold text-gray-700">Clef:</span>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all active" data-clef="treble" onclick="selectClef('treble', this)">
                        <span class="text-2xl">ùÑû</span> Treble
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-clef="bass" onclick="selectClef('bass', this)">
                        <span class="text-2xl">ùÑ¢</span> Bass
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-clef="alto" onclick="selectClef('alto', this)">
                        <span class="text-2xl">ùÑ°</span> Alto
                    </button>
                </div>

                <!-- Note Duration -->
                <div class="flex items-center gap-2 border-l-2 border-gray-300 pl-4">
                    <span class="font-semibold text-gray-700">Duration:</span>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all active" data-duration="w" onclick="selectDuration('w', this)">
                        <span class="text-2xl">ùÖù</span> Whole
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-duration="h" onclick="selectDuration('h', this)">
                        <span class="text-2xl">ùÖóùÖ•</span> Half
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-duration="q" onclick="selectDuration('q', this)">
                        <span class="text-2xl">ùÖòùÖ•</span> Quarter
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-duration="8" onclick="selectDuration('8', this)">
                        <span class="text-2xl">ùÖòùÖ•ùÖÆ</span> Eighth
                    </button>
                </div>

                <!-- Accidentals -->
                <div class="flex items-center gap-2 border-l-2 border-gray-300 pl-4">
                    <span class="font-semibold text-gray-700">Accidental:</span>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-accidental="none" onclick="selectAccidental('none', this)">
                        None
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-accidental="#" onclick="selectAccidental('#', this)">
                        <span class="text-xl">‚ôØ</span> Sharp
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-accidental="b" onclick="selectAccidental('b', this)">
                        <span class="text-xl">‚ô≠</span> Flat
                    </button>
                    <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" data-accidental="n" onclick="selectAccidental('n', this)">
                        <span class="text-xl">‚ôÆ</span> Natural
                    </button>
                </div>
            </div>

            <!-- Toolbar Row 2: Pitches -->
            <div class="flex flex-wrap gap-2 mb-4 p-4 bg-gray-50 rounded-lg">
                <span class="font-semibold text-gray-700 w-full mb-2">Pitches:</span>
                <div class="flex flex-col gap-2 w-full">
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-16">Oct 6:</span>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="c/6" onclick="selectPitch('c/6', this)">C</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="d/6" onclick="selectPitch('d/6', this)">D</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="e/6" onclick="selectPitch('e/6', this)">E</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="f/6" onclick="selectPitch('f/6', this)">F</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="g/6" onclick="selectPitch('g/6', this)">G</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="a/6" onclick="selectPitch('a/6', this)">A</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="b/6" onclick="selectPitch('b/6', this)">B</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-16">Oct 5:</span>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="c/5" onclick="selectPitch('c/5', this)">C</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="d/5" onclick="selectPitch('d/5', this)">D</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="e/5" onclick="selectPitch('e/5', this)">E</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="f/5" onclick="selectPitch('f/5', this)">F</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="g/5" onclick="selectPitch('g/5', this)">G</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="a/5" onclick="selectPitch('a/5', this)">A</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="b/5" onclick="selectPitch('b/5', this)">B</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-16">Oct 4:</span>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="c/4" onclick="selectPitch('c/4', this)">C</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm active" data-pitch="d/4" onclick="selectPitch('d/4', this)">D</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="e/4" onclick="selectPitch('e/4', this)">E</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="f/4" onclick="selectPitch('f/4', this)">F</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="g/4" onclick="selectPitch('g/4', this)">G</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="a/4" onclick="selectPitch('a/4', this)">A</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="b/4" onclick="selectPitch('b/4', this)">B</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-600 w-16">Oct 3:</span>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="c/3" onclick="selectPitch('c/3', this)">C</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="d/3" onclick="selectPitch('d/3', this)">D</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="e/3" onclick="selectPitch('e/3', this)">E</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="f/3" onclick="selectPitch('f/3', this)">F</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="g/3" onclick="selectPitch('g/3', this)">G</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="a/3" onclick="selectPitch('a/3', this)">A</button>
                        <button type="button" class="px-3 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all text-sm" data-pitch="b/3" onclick="selectPitch('b/3', this)">B</button>
                    </div>
                </div>
            </div>

            <!-- Toolbar Row 3: Actions -->
            <div class="flex flex-wrap gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                <!-- Chord Mode -->
                <button type="button" class="px-4 py-2 border-2 border-gray-300 bg-white rounded-lg hover:bg-gray-100 transition-all" id="chord-mode-btn" onclick="toggleChordMode()">
                    <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7zM4 7a1 1 0 011-1h10a1 1 0 110 2H5a1 1 0 01-1-1zM2 11a2 2 0 012-2h12a2 2 0 012 2v4a2 2 0 01-2 2H4a2 2 0 01-2-2v-4z"/>
                    </svg>
                    Chord Mode
                </button>

                <!-- Add Elements -->
                <div class="flex gap-2 border-l-2 border-gray-300 pl-4">
                    <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium" onclick="addNote()">
                        <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        <span id="add-note-text">Add Note</span>
                    </button>
                    <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium" onclick="addRest()">
                        Add Rest
                    </button>
                    <button type="button" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-medium" onclick="addBarline()">
                        Add Barline
                    </button>
                </div>

                <!-- Edit Actions -->
                <div class="flex gap-2 border-l-2 border-gray-300 pl-4">
                    <button type="button" class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-all font-medium" onclick="removeLast()">
                        Remove Last
                    </button>
                    <button type="button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all font-medium" onclick="clearNotation()">
                        Clear All
                    </button>
                </div>
            </div>

            <!-- Chord Builder (appears when in chord mode) -->
            <div id="chord-builder" class="bg-yellow-50 border-2 border-yellow-400 rounded-lg p-4 mb-6" style="display: none;">
                <div class="flex justify-between items-center mb-2">
                    <div>
                        <strong class="text-yellow-800">Building Chord:</strong>
                        <span id="chord-count" class="ml-2 text-yellow-700">0 notes</span>
                    </div>
                    <button type="button" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium" onclick="finishChord()">
                        Finish Chord
                    </button>
                </div>
                <div id="chord-notes-display" class="flex flex-wrap gap-2"></div>
            </div>

            <!-- Notation Display -->
            <div id="notation-output" class="border-2 border-gray-200 rounded-lg p-6 bg-white min-h-[200px] mb-6"></div>

            <!-- Modal Actions -->
            <div class="flex gap-4 justify-end pt-4 border-t-2 border-gray-200">
                <button type="button" onclick="closeNotationEditor()" class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-all font-semibold">
                    Cancel
                </button>
                <button type="button" onclick="saveNotation()" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-all font-semibold">
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                    </svg>
                    Save Notation
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- VexFlow Library from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/4.2.2/vexflow-min.js"></script>

<style>
.active {
    background-color: #4a90e2 !important;
    color: white !important;
    border-color: #4a90e2 !important;
}
</style>

<script>
// Wait for VexFlow to load
let VF;

// Editor state
let selectedClef = 'treble';
let selectedDuration = 'w';
let selectedPitch = 'd/4';
let selectedAccidental = 'none';
let notes = [];

// Chord mode state
let chordMode = false;
let currentChord = [];

// VexFlow objects
let renderer, context, stave;

// Open the notation editor modal
function openNotationEditor() {
    // Initialize VexFlow if not already done
    if (typeof Vex === 'undefined' || typeof Vex.Flow === 'undefined') {
        alert('Music notation library is still loading. Please wait a moment and try again.');
        return;
    }

    if (!VF) {
        VF = Vex.Flow;
    }

    document.getElementById('notation-editor-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    // Load existing notation data if any
    const existingData = document.getElementById('id_reference_notation').value;
    if (existingData) {
        try {
            const data = JSON.parse(existingData);
            selectedClef = data.clef || 'treble';
            notes = data.notes || [];
            renderNotes();
        } catch (e) {
            console.error('Error loading existing notation:', e);
        }
    } else {
        initNotation();
    }
}

// Close the notation editor modal
function closeNotationEditor() {
    document.getElementById('notation-editor-modal').classList.add('hidden');
    document.body.style.overflow = '';
}

// Initialize the notation display
function initNotation() {
    const outputDiv = document.getElementById('notation-output');
    outputDiv.innerHTML = '';

    renderer = new VF.Renderer(outputDiv, VF.Renderer.Backends.SVG);
    renderer.resize(1200, 200);
    context = renderer.getContext();

    stave = new VF.Stave(10, 40, 1150);
    stave.addClef(selectedClef);
    stave.addTimeSignature('4/4');
    stave.setContext(context).draw();

    if (notes.length > 0) {
        renderNotes();
    }
}

// Select clef
function selectClef(clef, button) {
    selectedClef = clef;
    document.querySelectorAll('[data-clef]').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    renderNotes();
}

// Select duration
function selectDuration(duration, button) {
    selectedDuration = duration;
    document.querySelectorAll('[data-duration]').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

// Select pitch
function selectPitch(pitch, button) {
    selectedPitch = pitch;
    document.querySelectorAll('[data-pitch]').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

// Select accidental
function selectAccidental(accidental, button) {
    selectedAccidental = accidental;
    document.querySelectorAll('[data-accidental]').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
}

// Toggle chord mode
function toggleChordMode() {
    chordMode = !chordMode;
    const chordModeBtn = document.getElementById('chord-mode-btn');
    const chordBuilder = document.getElementById('chord-builder');
    const addNoteText = document.getElementById('add-note-text');

    if (chordMode) {
        chordModeBtn.classList.add('active');
        chordBuilder.style.display = 'block';
        addNoteText.textContent = 'Add to Chord';
        currentChord = [];
        updateChordDisplay();
    } else {
        chordModeBtn.classList.remove('active');
        chordBuilder.style.display = 'none';
        addNoteText.textContent = 'Add Note';
        currentChord = [];
    }
}

// Update chord display
function updateChordDisplay() {
    const display = document.getElementById('chord-notes-display');
    const countSpan = document.getElementById('chord-count');

    countSpan.textContent = `${currentChord.length} note${currentChord.length !== 1 ? 's' : ''}`;

    display.innerHTML = '';
    currentChord.forEach((chordNote, index) => {
        const badge = document.createElement('div');
        badge.className = 'bg-blue-600 text-white px-3 py-1 rounded-lg text-sm font-medium flex items-center gap-2';

        let noteText = chordNote.pitch.toUpperCase().replace('/', '');
        if (chordNote.accidental && chordNote.accidental !== 'none') {
            const accSymbol = chordNote.accidental === '#' ? '‚ôØ' :
                            chordNote.accidental === 'b' ? '‚ô≠' : '‚ôÆ';
            noteText += accSymbol;
        }

        badge.innerHTML = `
            <span>${noteText}</span>
            <span class="cursor-pointer hover:text-red-200" onclick="removeFromChord(${index})">√ó</span>
        `;
        display.appendChild(badge);
    });
}

// Remove a note from current chord
function removeFromChord(index) {
    currentChord.splice(index, 1);
    updateChordDisplay();
}

// Add a note
function addNote() {
    if (chordMode) {
        currentChord.push({
            pitch: selectedPitch,
            accidental: selectedAccidental
        });
        updateChordDisplay();
    } else {
        const noteData = {
            type: 'note',
            keys: [selectedPitch],
            duration: selectedDuration
        };

        if (selectedAccidental !== 'none') {
            noteData.accidental = selectedAccidental;
        }

        notes.push(noteData);
        renderNotes();
    }
}

// Finish chord and add to staff
function finishChord() {
    if (currentChord.length === 0) {
        alert('Please add at least one note to the chord first.');
        return;
    }

    const sortedChord = [...currentChord].sort((a, b) => {
        const getPitchValue = (pitch) => {
            const [note, octave] = pitch.split('/');
            const noteValues = {c: 0, d: 1, e: 2, f: 3, g: 4, a: 5, b: 6};
            return parseInt(octave) * 7 + noteValues[note];
        };
        return getPitchValue(a.pitch) - getPitchValue(b.pitch);
    });

    const noteData = {
        type: 'note',
        keys: sortedChord.map(n => n.pitch),
        duration: selectedDuration,
        accidentals: sortedChord.map(n => n.accidental !== 'none' ? n.accidental : null)
    };

    notes.push(noteData);
    currentChord = [];
    updateChordDisplay();
    renderNotes();
}

// Add a rest
function addRest() {
    notes.push({
        type: 'rest',
        keys: ['b/4'],
        duration: selectedDuration + 'r'
    });
    renderNotes();
}

// Add a barline
function addBarline() {
    notes.push({
        type: 'barline'
    });
    renderNotes();
}

// Remove last element
function removeLast() {
    if (notes.length > 0) {
        notes.pop();
        renderNotes();
    }
}

// Render all notes
function renderNotes() {
    const outputDiv = document.getElementById('notation-output');
    outputDiv.innerHTML = '';

    renderer = new VF.Renderer(outputDiv, VF.Renderer.Backends.SVG);
    renderer.resize(1200, 200);
    context = renderer.getContext();

    stave = new VF.Stave(10, 40, 1150);
    stave.addClef(selectedClef);
    stave.addTimeSignature('4/4');
    stave.setContext(context).draw();

    if (notes.length === 0) return;

    try {
        const vfNotes = notes.map(noteData => {
            if (noteData.type === 'barline') {
                return new VF.BarNote();
            } else {
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration
                });

                if (noteData.accidental) {
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                } else if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        });

        if (vfNotes.length === 0) return;

        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 1100);
        voice.draw(context, stave);

    } catch (error) {
        console.error('Error rendering notes:', error);
        alert('Error rendering notes: ' + error.message);
    }
}

// Clear all notes
function clearNotation() {
    if (confirm('Are you sure you want to clear all notes?')) {
        notes = [];
        initNotation();
    }
}

// Save notation and close modal
function saveNotation() {
    if (notes.length === 0) {
        alert('Please add some notes before saving.');
        return;
    }

    const exportData = {
        clef: selectedClef,
        notes: notes
    };

    // Save to hidden input
    document.getElementById('id_reference_notation').value = JSON.stringify(exportData);

    // Show preview
    showNotationPreview();

    // Update button text
    document.getElementById('editor-button-text').textContent = 'Edit Notation';

    // Close modal
    closeNotationEditor();
}

// Show notation preview
function showNotationPreview() {
    const previewContainer = document.getElementById('notation-preview-container');
    const previewDiv = document.getElementById('notation-preview');

    previewContainer.style.display = 'block';
    previewDiv.innerHTML = '';

    const previewRenderer = new VF.Renderer(previewDiv, VF.Renderer.Backends.SVG);
    previewRenderer.resize(800, 150);
    const previewContext = previewRenderer.getContext();

    const previewStave = new VF.Stave(10, 20, 750);
    previewStave.addClef(selectedClef);
    previewStave.addTimeSignature('4/4');
    previewStave.setContext(previewContext).draw();

    if (notes.length === 0) return;

    try {
        const vfNotes = notes.map(noteData => {
            if (noteData.type === 'barline') {
                return new VF.BarNote();
            } else {
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration
                });

                if (noteData.accidental) {
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                } else if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        });

        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 700);
        voice.draw(previewContext, previewStave);

    } catch (error) {
        console.error('Error rendering preview:', error);
    }
}

// Clear notation data
function clearNotationData() {
    if (confirm('Are you sure you want to clear the reference notation?')) {
        document.getElementById('id_reference_notation').value = '';
        document.getElementById('notation-preview-container').style.display = 'none';
        document.getElementById('editor-button-text').textContent = 'Open Notation Editor';
        notes = [];
    }
}

// Load existing notation on page load if present
document.addEventListener('DOMContentLoaded', function() {
    // Initialize VexFlow when page loads
    if (typeof Vex !== 'undefined' && typeof Vex.Flow !== 'undefined') {
        VF = Vex.Flow;
    }

    const existingData = document.getElementById('id_reference_notation').value;
    if (existingData) {
        try {
            const data = JSON.parse(existingData);
            selectedClef = data.clef || 'treble';
            notes = data.notes || [];

            // Only show preview if VexFlow is loaded
            if (VF) {
                showNotationPreview();
                document.getElementById('editor-button-text').textContent = 'Edit Notation';
            }
        } catch (e) {
            console.error('Error loading existing notation:', e);
        }
    }
});
</script>
{% endblock %}
