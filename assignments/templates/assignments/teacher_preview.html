{% extends 'base.html' %}
{% load static %}

{% block title %}Preview: {{ assignment.title }}{% endblock %}

{% block extra_css %}
<style>
    #reference-notation-display {
        background-color: white;
        border-radius: 8px;
        padding: 20px;
        min-height: 150px;
        border: 1px solid #e5e7eb;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Preview Banner -->
    <div class="alert alert-info mb-6">
        <i class="fas fa-eye text-2xl"></i>
        <div>
            <h3 class="font-bold">Preview Mode</h3>
            <div class="text-sm">This is how students will see this assignment (read-only)</div>
        </div>
        <div class="flex gap-2">
            <a href="{% url 'assignments:teacher_edit' assignment.id %}" class="btn btn-sm btn-outline">
                <i class="fas fa-edit mr-2"></i>Edit Assignment
            </a>
            <a href="{% url 'assignments:teacher_library' %}" class="btn btn-sm btn-ghost">
                <i class="fas fa-arrow-left mr-2"></i>Back to Library
            </a>
        </div>
    </div>

    <!-- Assignment Card -->
    <div class="card card-section shadow-xl">
        <div class="card-body">
            <!-- Assignment Header -->
            <div class="mb-6">
                <h1 class="text-4xl font-bold mb-3">{{ assignment.title }}</h1>

                <!-- Assignment Type Badges -->
                <div class="flex gap-2 mb-4">
                    {% if assignment.has_notation_component %}
                        <span class="badge badge-primary">
                            <i class="fas fa-music mr-1"></i>Notation Component
                        </span>
                    {% endif %}
                    {% if assignment.has_written_component %}
                        <span class="badge badge-secondary">
                            <i class="fas fa-pen mr-1"></i>Written Component
                        </span>
                    {% endif %}
                    {% if assignment.difficulty %}
                        <span class="badge badge-accent">
                            {{ assignment.get_difficulty_display }}
                        </span>
                    {% endif %}
                    <span class="badge badge-outline">
                        {{ assignment.get_grading_scale_display }}
                    </span>
                </div>

                <!-- Tags -->
                {% if assignment.tags.all %}
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for tag in assignment.tags.all %}
                    <span class="badge badge-lg badge-ghost">
                        <i class="fas fa-tag mr-1"></i>{{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Instructions -->
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-3">
                    <i class="fas fa-info-circle mr-2 text-primary"></i>Instructions
                </h2>
                <div class="prose max-w-none">
                    <p class="whitespace-pre-wrap text-lg">{{ assignment.instructions }}</p>
                </div>
            </div>

            <!-- Reference Notation/Image (if provided) -->
            {% if assignment.reference_notation or assignment.reference_image %}
            <div class="mb-8">
                <h2 class="text-2xl font-bold mb-3">
                    <i class="fas fa-eye mr-2 text-primary"></i>Reference/Example
                </h2>
                <div class="alert alert-info mb-4">
                    <i class="fas fa-info-circle"></i>
                    <span>This is exactly how students will see the reference notation/image in their assignment</span>
                </div>
                {% if assignment.reference_image %}
                    <div class="p-4 bg-gray-50 rounded-lg border-2 border-gray-200">
                        <img src="{{ assignment.reference_image.url }}" alt="Reference notation" class="max-w-full h-auto mx-auto">
                    </div>
                {% elif assignment.reference_notation %}
                    <div id="reference-notation-display"></div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Student Work Areas (Preview) -->
            <div class="divider my-8"></div>

            <h2 class="text-2xl font-bold mb-4">
                <i class="fas fa-pencil-alt mr-2 text-primary"></i>Student Work Areas
            </h2>

            {% if assignment.has_notation_component %}
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-3">Notation Editor</h3>
                <div class="bg-base-200 p-8 rounded-lg text-center">
                    <i class="fas fa-music text-6xl text-base-content/30 mb-4"></i>
                    <p class="text-base-content/70">Students will use the interactive VexFlow notation editor here</p>
                    <p class="text-sm text-base-content/50 mt-2">They can compose music notation as their response</p>
                </div>
            </div>
            {% endif %}

            {% if assignment.has_written_component %}
            <div class="mb-8">
                <h3 class="text-xl font-bold mb-3">Written Response</h3>
                <div class="bg-base-200 p-8 rounded-lg text-center">
                    <i class="fas fa-pen-fancy text-6xl text-base-content/30 mb-4"></i>
                    <p class="text-base-content/70">Students will use the rich text editor here</p>
                    <p class="text-sm text-base-content/50 mt-2">They can write formatted text responses with bold, italic, lists, etc.</p>
                </div>
            </div>
            {% endif %}

            <!-- Action Buttons (Preview Only) -->
            <div class="divider my-8"></div>

            <div class="flex justify-between items-center">
                <div class="text-sm text-base-content/70">
                    <i class="fas fa-info-circle mr-2"></i>
                    In the actual assignment, students would see "Save Draft" and "Submit Assignment" buttons here
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-outline btn-disabled">
                        <i class="fas fa-save mr-2"></i>Save Draft
                    </button>
                    <button class="btn btn-primary btn-disabled">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Assignment
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Info -->
    <div class="card bg-base-200 mt-6">
        <div class="card-body">
            <h3 class="card-title">
                <i class="fas fa-lightbulb mr-2"></i>Preview Information
            </h3>
            <ul class="list-disc list-inside space-y-2 text-sm">
                <li>This preview shows the assignment content and structure as students will see it</li>
                <li>The actual notation editor and rich text editor are interactive in the real assignment</li>
                <li>Students can save drafts and come back to continue their work</li>
                <li>Once submitted, you'll be able to grade the assignment and provide feedback</li>
                {% if assignment.grading_scale == 'pass_fail' %}
                <li>This assignment uses <strong>Pass/Fail</strong> grading</li>
                {% elif assignment.grading_scale == '10' %}
                <li>This assignment will be graded on a <strong>0-10 point scale</strong></li>
                {% else %}
                <li>This assignment will be graded on a <strong>0-100 point scale</strong></li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

{% if assignment.reference_notation %}
<script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.2/build/cjs/vexflow.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const VF = Vex.Flow;

    // Render reference notation
    {% if assignment.reference_notation %}
    const referenceNotationData = {{ assignment.reference_notation|safe }};
    renderNotation('reference-notation-display', referenceNotationData);
    {% endif %}

    function renderNotation(containerId, notationData) {
        const container = document.getElementById(containerId);
        if (!container || !notationData) {
            return;
        }

        // Clear container
        container.innerHTML = '';

        // Create renderer
        const renderer = new VF.Renderer(container, VF.Renderer.Backends.SVG);
        renderer.resize(700, 200);
        const context = renderer.getContext();

        // Create stave
        const stave = new VF.Stave(10, 40, 680);

        // Add clef and key signature
        const clef = notationData.clef || 'treble';
        const keySignature = notationData.keySignature || '';

        stave.addClef(clef);
        if (keySignature) {
            stave.addKeySignature(keySignature);
        }
        stave.setContext(context).draw();

        // If there are no notes, just show the empty stave
        if (!notationData.notes || notationData.notes.length === 0) {
            return;
        }

        // Create notes
        const vfNotes = notationData.notes.map(noteData => {
            if (noteData.type === 'barline') {
                return new VF.BarNote();
            } else {
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration,
                    clef: clef
                });

                // Handle single note accidentals
                if (noteData.accidental) {
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                }

                // Handle chord accidentals
                if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        });

        // Create voice and format
        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);  // Don't strictly enforce beat counting
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 650);

        // Draw voice
        voice.draw(context, stave);
    }
});
</script>
{% endif %}
{% endblock %}
