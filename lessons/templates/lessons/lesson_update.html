{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Lesson - {{ lesson.subject.subject }}{% endblock %}

{% block extra_head %}
{{ form.media }}
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/44.1.0/ckeditor5.css" />
<link rel="stylesheet" href="{% static 'css/ckeditor_custom.css' %}?v=3" type="text/css">
<link rel="stylesheet" href="{% static 'css/imagestyle.css' %}?v=3" type="text/css">
<style>
.lesson-header {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #065f46;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.lesson-detail-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.lesson-detail-item:last-child {
    border-bottom: none;
}

.lesson-detail-label {
    font-weight: 600;
    color: #374151;
}

.lesson-detail-value {
    color: #6b7280;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-assigned {
    background: #10b981;
    color: white;
}

.status-draft {
    background: #6b7280;
    color: white;
}

.payment-paid {
    color: #10b981;
    font-weight: 600;
}

.payment-unpaid {
    color: #f59e0b;
    font-weight: 600;
}

.section-divider {
    border-top: 2px solid #e5e7eb;
    margin: 2rem 0;
    padding-top: 2rem;
}

.form-section {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.form-section h3 {
    color: #065f46;
    font-weight: 600;
    margin-bottom: 1rem;
    border-bottom: 2px solid #10b981;
    padding-bottom: 0.5rem;
}

.zoom-link-field input {
    width: 100% !important;
    min-width: 500px !important;
    padding: 0.5rem !important;
    border: 1px solid #d1d5db !important;
    border-radius: 4px !important;
}

/* Make content fields full width */
.form-section textarea,
.form-section .django-ckeditor-widget,
.form-section .django-ckeditor-5,
.form-section .cke,
.form-section .ck-editor {
    width: 100% !important;
    min-width: 100% !important;
}

.form-section .cke_contents,
.form-section .ck-editor__editable {
    min-height: 200px !important;
}

/* Document file display improvements */
.form-section input[type="file"] {
    word-break: break-all;
    white-space: normal;
    overflow-wrap: break-word;
}

.document-file-display {
    word-break: break-all;
    white-space: normal;
    overflow-wrap: break-word;
    max-width: 100%;
    display: block;
}

.inline-form {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.inline-form.empty {
    background: #f3f4f6;
    border-style: dashed;
}

.delete-checkbox {
    color: #dc2626;
}

.btn-add-form {
    background: #065f46;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}

.btn-add-form:hover {
    background: #047857;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-6xl">
    <!-- Lesson Header with Details -->
    <div class="lesson-header">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold mb-4">
                    {{ lesson.subject.subject }} |
                    {% if lesson.lesson_request.child_profile %}
                        {{ lesson.lesson_request.child_profile.full_name }}
                        <span class="text-xl text-white/80 font-normal">(Guardian: {{ lesson.student.get_full_name|default:"Unknown" }})</span>
                    {% else %}
                        {{ lesson.student.get_full_name|default:lesson.student.username|default:"Unknown Student" }}
                    {% endif %}
                </h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Lesson Date:</span>
                            <span class="lesson-detail-value text-white">{{ lesson.lesson_date|date:"M j, Y" }} {{ lesson.lesson_time|time:"g:i A" }}</span>
                        </div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Fee:</span>
                            <span class="lesson-detail-value text-white">¬£{{ lesson.fee|floatformat:2|default:"Not set" }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Duration:</span>
                            <span class="lesson-detail-value text-white">{{ lesson.duration_in_minutes }} mins</span>
                        </div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Status:</span>
                            <span class="status-badge {% if lesson.status == 'Assigned' %}status-assigned{% else %}status-draft{% endif %}">{{ lesson.status }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm opacity-80 mb-2">Payment Status</div>
                <div class="{% if lesson.payment_status == 'Paid' %}payment-paid{% else %}payment-unpaid{% endif %} text-lg font-bold">
                    {{ lesson.payment_status }}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex gap-4 mb-6">
        <a href="{% url 'private_teaching:calendar' %}" class="btn btn-outline">‚Üê Back to Calendar</a>
    </div>

    <!-- Edit Form -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Basic Settings -->
        <div class="form-section">
            <h3>Lesson Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    {{ form.location }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Attendance</label>
                    {{ form.attendance }}
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Zoom Link</label>
                <div class="zoom-link-field">
                    {{ form.zoom_link }}
                </div>
                <small class="text-gray-500">Can be set by teacher in teacher settings or edited here</small>
            </div>
        </div>

        <!-- Lesson Content -->
        <div class="form-section">
            <h3>Lesson Content</h3>
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="block text-sm font-medium text-gray-700">Lesson Content</label>
                    <div class="flex gap-2">
                        <div class="relative">
                            <button type="button" id="insert-template-btn" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                üìö Insert Template
                            </button>
                            <div id="template-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                                <div class="p-3 border-b border-gray-200 bg-gray-50">
                                    <h4 class="font-semibold text-gray-700">Select Lesson Template</h4>
                                </div>
                                <div id="template-list" class="max-h-96 overflow-y-auto p-2">
                                    <!-- Template items will be inserted here -->
                                </div>
                            </div>
                        </div>
                        <div class="relative">
                            <button type="button" id="insert-homework-btn" class="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500">
                                üìã Insert Previous Homework
                            </button>
                            <div id="homework-dropdown" class="hidden absolute right-0 mt-2 w-96 bg-white border border-gray-300 rounded-lg shadow-lg z-50">
                                <div class="p-3 border-b border-gray-200 bg-gray-50">
                                    <h4 class="font-semibold text-gray-700">Select Previous Homework</h4>
                                </div>
                                <div id="homework-list" class="max-h-96 overflow-y-auto">
                                    <!-- Homework items will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {{ form.lesson_content }}
            </div>
        </div>

        <!-- Teacher Notes -->
        <div class="form-section">
            <h3>Teacher Notes</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Teacher Notes</label>
                {{ form.teacher_notes }}
            </div>
        </div>

        <!-- Homework -->
        <div class="form-section">
            <h3>Homework</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Homework</label>
                {{ form.homework }}
            </div>
        </div>

        <!-- Private Notes -->
        <div class="form-section">
            <h3>Private Notes</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Private Notes</label>
                {{ form.private_note }}
                <small class="text-gray-500">Not visible to students</small>
            </div>
        </div>

        <!-- Status -->
        <div class="form-section">
            <h3>Publication Status</h3>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                {{ form.status }}
                <small class="text-gray-500">Draft = not visible to student, Assigned = visible to student</small>
            </div>
        </div>

        <!-- Document Uploads -->
        <div class="form-section">
            <h3>Document Uploads</h3>
            {{ named_formsets.documents.management_form }}
            <div id="document-forms">
                {% for form in named_formsets.documents %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="font-medium mb-3">Document #{{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="font-medium mb-3 text-gray-500">New Document</h4>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                {{ form.title }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Document File</label>
                                {% if form.instance.pk and form.instance.document %}
                                    <div class="document-file-display mb-2">
                                        <a href="{{ form.instance.document.url }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            {{ form.instance.document.name|cut:"lesson_documents/" }}
                                        </a>
                                    </div>
                                    {{ form.document.as_hidden }}
                                    <input type="file" name="{{ form.document.html_name }}" id="{{ form.document.id_for_label }}" class="form-control">
                                {% else %}
                                    {{ form.document }}
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox cursor-pointer">Delete this document</label>
                            </div>
                        {% endif %}
                        
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-document" class="btn-add-form mt-3">+ Add Document</button>
        </div>

        <!-- URL Attachments -->
        <div class="form-section">
            <h3>URL Attachments</h3>
            {{ named_formsets.lesson_attached_urls.management_form }}
            <div id="url-forms">
                {% for form in named_formsets.lesson_attached_urls %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="font-medium mb-3">URL #{{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="font-medium mb-3 text-gray-500">New URL</h4>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                {{ form.name }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                                {{ form.url }}
                            </div>
                        </div>
                        
                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox">Delete this URL</label>
                            </div>
                        {% endif %}
                        
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-url" class="btn-add-form mt-3">+ Add URL</button>
        </div>

        <!-- Playalong Pieces -->
        <div class="form-section">
            <h3>üéµ Playalong Pieces</h3>
            <p class="text-sm text-gray-600 mb-4">Add interactive rhythm exercises and playalong content for this lesson. Students can access these when the lesson status is "Assigned".</p>
            {{ named_formsets.pieces.management_form }}
            <div id="piece-forms">
                {% for form in named_formsets.pieces %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Piece {{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">New Piece</h4>
                        {% endif %}

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Piece</label>
                                {{ form.piece }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                                {{ form.order }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                            {{ form.instructions }}
                            <small class="text-gray-500">Optional: Add specific guidance for this piece in this lesson</small>
                        </div>
                        <div class="flex gap-6 mb-3">
                            <div class="flex items-center gap-2">
                                {{ form.is_visible }}
                                <label for="{{ form.is_visible.id_for_label }}" class="text-sm">Visible to student</label>
                            </div>
                            <div class="flex items-center gap-2">
                                {{ form.is_optional }}
                                <label for="{{ form.is_optional.id_for_label }}" class="text-sm">Mark as optional</label>
                            </div>
                        </div>

                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox">Delete this piece</label>
                            </div>
                        {% endif %}

                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="flex items-center gap-2 mt-3">
                <button type="button" id="add-piece" class="btn-add-form">+ Add Piece</button>
                <a href="{% url 'audioplayer:piece_list' %}" target="_blank" class="btn btn-outline">Manage Piece Library</a>
            </div>
        </div>

        <!-- Homework Assignments Section -->
        <div class="form-section">
            <h3>üìù Homework Assignments</h3>
            <p class="text-sm text-gray-600 mb-4">Assign homework for this lesson. Students will see these assignments in their student portal.</p>
            {{ named_formsets.assignments.management_form }}
            <div id="assignment-forms">
                {% for form in named_formsets.assignments %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Assignment {{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">New Assignment</h4>
                        {% endif %}

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Assignment</label>
                                {{ form.assignment }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                                {{ form.due_date }}
                                <small class="text-gray-500">Optional - defaults to next lesson</small>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                            {{ form.order }}
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                            {{ form.instructions }}
                            <small class="text-gray-500">Optional: Add specific guidance for this assignment</small>
                        </div>

                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox">Delete this assignment</label>
                            </div>
                        {% endif %}

                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="flex items-center gap-2 mt-3">
                <button type="button" id="add-assignment" class="btn-add-form">+ Add Assignment</button>
                <a href="{% url 'assignments:teacher_library' %}" target="_blank" class="btn btn-outline">Manage Assignment Library</a>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-4 pt-6 border-t border-gray-200">
            <button type="submit" class="btn btn-primary">Save Lesson</button>
            <a href="{% url 'lessons:lesson_detail' lesson.pk %}" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>

<script>
// Handle form errors and dynamic formsets
document.addEventListener('DOMContentLoaded', function() {
    console.log('Lesson edit form loaded');

    // Previous Homework Insertion Feature
    const insertHomeworkBtn = document.getElementById('insert-homework-btn');
    const homeworkDropdown = document.getElementById('homework-dropdown');
    const homeworkList = document.getElementById('homework-list');
    let ckeditorInstance = null;

    // Get CKEditor instance (it's initialized by Django's CKEditor5Widget)
    function getCKEditorInstance() {
        // Method 1: Try to find editor through the .ck-editor container
        const editorContainers = document.querySelectorAll('.ck-editor');
        for (let container of editorContainers) {
            // Check if this container is for our lesson_content field
            const prevElement = container.previousElementSibling;
            if (prevElement && prevElement.name === 'lesson_content') {
                // Get the editable element
                const editableElement = container.querySelector('.ck-editor__editable');
                if (editableElement && editableElement.ckeditorInstance) {
                    console.log('Found CKEditor instance via editableElement.ckeditorInstance');
                    return editableElement.ckeditorInstance;
                }
            }
        }

        // Method 2: Try global CKEDITOR object (if available)
        if (window.CKEDITOR && window.CKEDITOR.instances) {
            const instances = window.CKEDITOR.instances;
            for (let key in instances) {
                console.log('Found CKEditor instance via CKEDITOR.instances:', key);
                return instances[key];
            }
        }

        console.warn('Could not find CKEditor instance');
        return null;
    }

    // Toggle dropdown visibility
    insertHomeworkBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (homeworkDropdown.classList.contains('hidden')) {
            // Show dropdown and fetch homework
            homeworkDropdown.classList.remove('hidden');
            fetchPreviousHomework();
        } else {
            // Hide dropdown
            homeworkDropdown.classList.add('hidden');
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!homeworkDropdown.contains(e.target) && e.target !== insertHomeworkBtn) {
            homeworkDropdown.classList.add('hidden');
        }
    });

    // Fetch previous homework from the server
    function fetchPreviousHomework() {
        homeworkList.innerHTML = '<div class="p-4 text-center text-gray-500">Loading...</div>';

        // Get lesson ID from the URL
        // URL format: /lessons/<uuid>/edit/ or /lessons/<uuid>/edit
        const pathParts = window.location.pathname.split('/').filter(p => p); // Remove empty strings
        const lessonsIndex = pathParts.indexOf('lessons');
        const lessonId = pathParts[lessonsIndex + 1]; // UUID comes right after 'lessons'

        console.log('Extracted lesson ID:', lessonId, 'from path:', window.location.pathname);

        fetch(`/lessons/api/${lessonId}/previous-homework/`)
            .then(response => {
                if (!response.ok) {
                    // Try to get error details from response
                    return response.json().then(errorData => {
                        throw new Error(errorData.error || 'Failed to fetch homework');
                    }).catch(() => {
                        throw new Error(`Server error: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Previous homework data:', data);
                if (data.lessons && data.lessons.length > 0) {
                    displayHomeworkList(data.lessons);
                } else {
                    homeworkList.innerHTML = '<div class="p-4 text-center text-gray-500">There is no previous lesson homework for this student.</div>';
                }
            })
            .catch(error => {
                console.error('Error fetching homework:', error);
                // Check if it's a permission error
                if (error.message.includes('Permission denied') || error.message.includes('403')) {
                    homeworkList.innerHTML = '<div class="p-4 text-center text-red-500">You do not have permission to view homework for this lesson.</div>';
                } else if (error.message.includes('401')) {
                    homeworkList.innerHTML = '<div class="p-4 text-center text-red-500">Please log in to view homework.</div>';
                } else {
                    homeworkList.innerHTML = '<div class="p-4 text-center text-gray-500">Unable to load previous homework. This may be the first lesson for this student.</div>';
                }
            });
    }

    // HTML escape function to prevent XSS
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Display the list of previous homework
    function displayHomeworkList(lessons) {
        homeworkList.innerHTML = '';

        lessons.forEach(lesson => {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 transition-colors';
            itemDiv.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="font-medium text-gray-700">${escapeHtml(lesson.subject)}</span>
                    <span class="text-xs text-gray-500">${escapeHtml(lesson.date)}</span>
                </div>
                <div class="text-sm text-gray-600 truncate">${escapeHtml(lesson.preview)}</div>
            `;

            itemDiv.addEventListener('click', function() {
                insertHomeworkIntoEditor(lesson.homework);
                homeworkDropdown.classList.add('hidden');
            });

            homeworkList.appendChild(itemDiv);
        });
    }

    // Insert homework into CKEditor at cursor position
    function insertHomeworkIntoEditor(homeworkText) {
        console.log('Attempting to insert homework:', homeworkText.substring(0, 50) + '...');

        // Try to get CKEditor instance
        if (!ckeditorInstance) {
            ckeditorInstance = getCKEditorInstance();
        }

        if (ckeditorInstance) {
            try {
                console.log('CKEditor instance found, attempting insertion');
                // Insert at cursor position using CKEditor5 API
                ckeditorInstance.model.change(writer => {
                    const insertPosition = ckeditorInstance.model.document.selection.getFirstPosition();
                    writer.insertText(homeworkText, insertPosition);
                });

                // Focus the editor
                ckeditorInstance.editing.view.focus();
                console.log('Homework inserted successfully');
                return;
            } catch (error) {
                console.error('Error inserting into CKEditor:', error);
            }
        }

        // Fallback: Try to manipulate the editor via execCommand
        console.log('Trying fallback method: execCommand');
        const editableElement = document.querySelector('.ck-editor__editable');
        if (editableElement) {
            try {
                editableElement.focus();
                document.execCommand('insertText', false, homeworkText);
                console.log('Homework inserted via execCommand');
                return;
            } catch (error) {
                console.error('Error with execCommand:', error);
            }
        }

        // Final fallback: Append to existing content
        console.log('Using final fallback: appending to content');
        if (ckeditorInstance) {
            try {
                const currentData = ckeditorInstance.getData();
                ckeditorInstance.setData(currentData + '\n\n' + homeworkText);
                console.log('Homework appended to content');
                alert('Homework has been added to the end of the lesson content.');
            } catch (error) {
                console.error('Error appending to content:', error);
                alert('Could not insert homework. Please copy it manually:\n\n' + homeworkText);
            }
        } else {
            alert('Could not access the editor. Please copy this homework manually:\n\n' + homeworkText);
        }
    }

    // ============= TEMPLATE INSERTION FUNCTIONALITY =============
    const insertTemplateBtn = document.getElementById('insert-template-btn');
    const templateDropdown = document.getElementById('template-dropdown');
    const templateList = document.getElementById('template-list');

    // Toggle template dropdown
    insertTemplateBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        if (templateDropdown.classList.contains('hidden')) {
            templateDropdown.classList.remove('hidden');
            fetchLessonTemplates();
        } else {
            templateDropdown.classList.add('hidden');
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!templateDropdown.contains(e.target) && e.target !== insertTemplateBtn) {
            templateDropdown.classList.add('hidden');
        }
    });

    // Fetch lesson templates from the server
    function fetchLessonTemplates() {
        templateList.innerHTML = '<div class="p-4 text-center text-gray-500">Loading templates...</div>';

        fetch('/lesson-templates/?mode=my_templates', {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            // Parse the HTML to extract template data
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const templateCards = doc.querySelectorAll('[data-template-id]');

            if (templateCards.length === 0) {
                templateList.innerHTML = '<div class="p-4 text-center text-gray-500">No templates found. <a href="/lesson-templates/create/" class="text-blue-600 hover:underline">Create one</a></div>';
                return;
            }

            templateList.innerHTML = '';
            templateCards.forEach(card => {
                const templateId = card.dataset.templateId;
                const title = card.querySelector('h2').textContent.trim();
                const itemDiv = document.createElement('div');
                itemDiv.className = 'p-3 hover:bg-gray-50 cursor-pointer border-b border-gray-100 rounded';
                itemDiv.innerHTML = `
                    <div class="font-semibold text-gray-800">${title}</div>
                `;
                itemDiv.addEventListener('click', function() {
                    insertTemplate(templateId, title);
                });
                templateList.appendChild(itemDiv);
            });
        })
        .catch(error => {
            console.error('Error fetching templates:', error);
            templateList.innerHTML = '<div class="p-4 text-center text-red-500">Error loading templates</div>';
        });
    }

    // Insert template content into editor
    function insertTemplate(templateId, title) {
        fetch(`/lesson-templates/api/${templateId}/content/`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                insertContentIntoEditor(data.content);
                templateDropdown.classList.add('hidden');
            } else {
                alert('Error loading template content');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading template content');
        });
    }

    // Insert content into CKEditor
    function insertContentIntoEditor(content) {
        if (!ckeditorInstance) {
            ckeditorInstance = getCKEditorInstance();
        }

        if (ckeditorInstance) {
            try {
                const currentData = ckeditorInstance.getData();
                ckeditorInstance.setData(currentData + '\n\n' + content);
                console.log('Template content inserted');
            } catch (error) {
                console.error('Error inserting template:', error);
                alert('Could not insert template. Please try again.');
            }
        } else {
            alert('Could not access the editor. Please try again.');
        }
    }

    // Wait for CKEditor to be ready - poll every 500ms for up to 10 seconds
    const startTime = Date.now();
    const editorCheckInterval = setInterval(function() {
        if (!ckeditorInstance) {
            ckeditorInstance = getCKEditorInstance();
            if (ckeditorInstance) {
                console.log('CKEditor instance found and cached');
                clearInterval(editorCheckInterval);
            }
        } else {
            clearInterval(editorCheckInterval);
        }

        // Stop checking after 10 seconds
        if (Date.now() - startTime > 10000) {
            if (!ckeditorInstance) {
                console.warn('CKEditor instance not found after 10 seconds, will try again when inserting');
            }
            clearInterval(editorCheckInterval);
        }
    }, 500);
    
    // Add visual feedback for delete checkboxes
    document.querySelectorAll('input[name*="DELETE"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const container = this.closest('.inline-form');
            if (this.checked) {
                container.style.opacity = '0.5';
                container.style.textDecoration = 'line-through';
                console.log('Marked for deletion:', this.name);
            } else {
                container.style.opacity = '1';
                container.style.textDecoration = 'none';
                console.log('Unmarked for deletion:', this.name);
            }
        });
    });
    
    // Function to add new document form
    document.getElementById('add-document').addEventListener('click', function() {
        const container = document.getElementById('document-forms');
        const totalForms = document.querySelector('#id_documents-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);
        
        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="font-medium mb-3">New Document</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="documents-${formIdx}-title" id="id_documents-${formIdx}-title" class="form-control">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document File</label>
                        <input type="file" name="documents-${formIdx}-document" id="id_documents-${formIdx}-document" class="form-control">
                    </div>
                </div>
                <input type="hidden" name="documents-${formIdx}-id" id="id_documents-${formIdx}-id">
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });
    
    // Function to add new URL form
    document.getElementById('add-url').addEventListener('click', function() {
        const container = document.getElementById('url-forms');
        const totalForms = document.querySelector('#id_lesson_attached_urls-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);
        
        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="font-medium mb-3">New URL</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" name="lesson_attached_urls-${formIdx}-name" id="id_lesson_attached_urls-${formIdx}-name" class="form-control">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                        <input type="url" name="lesson_attached_urls-${formIdx}-url" id="id_lesson_attached_urls-${formIdx}-url" class="form-control">
                    </div>
                </div>
                <input type="hidden" name="lesson_attached_urls-${formIdx}-id" id="id_lesson_attached_urls-${formIdx}-id">
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });

    // Function to add new piece form
    document.getElementById('add-piece').addEventListener('click', function() {
        const container = document.getElementById('piece-forms');
        const totalForms = document.querySelector('#id_pieces-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);

        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">New Piece</h4>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Piece</label>
                        <select name="pieces-${formIdx}-piece" id="id_pieces-${formIdx}-piece" class="form-control">
                            <option value="">---------</option>
                            {% for piece in pieces %}
                            <option value="{{ piece.id }}">{{ piece.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                        <input type="number" name="pieces-${formIdx}-order" id="id_pieces-${formIdx}-order" value="0" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                    <textarea name="pieces-${formIdx}-instructions" id="id_pieces-${formIdx}-instructions" rows="3" class="form-control"></textarea>
                    <small class="text-gray-500">Optional: Add specific guidance for this piece in this lesson</small>
                </div>
                <div class="flex gap-6 mb-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="pieces-${formIdx}-is_visible" id="id_pieces-${formIdx}-is_visible" checked class="form-checkbox">
                        <label for="id_pieces-${formIdx}-is_visible" class="text-sm">Visible to student</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="pieces-${formIdx}-is_optional" id="id_pieces-${formIdx}-is_optional" class="form-checkbox">
                        <label for="id_pieces-${formIdx}-is_optional" class="text-sm">Mark as optional</label>
                    </div>
                </div>
                <input type="hidden" name="pieces-${formIdx}-id" id="id_pieces-${formIdx}-id">
            </div>
        `;

        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });

    // Function to add new assignment form
    document.getElementById('add-assignment').addEventListener('click', function() {
        const container = document.getElementById('assignment-forms');
        const totalForms = document.querySelector('#id_assignments-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);

        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">New Assignment</h4>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Assignment</label>
                        <select name="assignments-${formIdx}-assignment" id="id_assignments-${formIdx}-assignment" class="form-control">
                            <option value="">---------</option>
                            {% for assignment in available_assignments %}
                            <option value="{{ assignment.id }}">{{ assignment.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Due Date</label>
                        <input type="datetime-local" name="assignments-${formIdx}-due_date" id="id_assignments-${formIdx}-due_date" class="form-control">
                        <small class="text-gray-500">Optional - defaults to next lesson</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                    <input type="number" name="assignments-${formIdx}-order" id="id_assignments-${formIdx}-order" value="0" class="form-control">
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                    <textarea name="assignments-${formIdx}-instructions" id="id_assignments-${formIdx}-instructions" rows="3" class="form-control"></textarea>
                    <small class="text-gray-500">Optional: Add specific guidance for this assignment</small>
                </div>
                <input type="hidden" name="assignments-${formIdx}-id" id="id_assignments-${formIdx}-id">
            </div>
        `;

        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });
});
</script>
{% endblock %}