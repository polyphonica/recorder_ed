{% extends 'base.html' %}
{% load static %}

{% block title %}Edit Lesson - {{ lesson.subject.subject }}{% endblock %}

{% block extra_head %}
{{ form.media }}
<link rel="stylesheet" href="https://cdn.ckeditor.com/ckeditor5/44.1.0/ckeditor5.css" />
<link rel="stylesheet" href="{% static 'css/ckeditor_custom.css' %}?v=3" type="text/css">
<link rel="stylesheet" href="{% static 'css/imagestyle.css' %}?v=3" type="text/css">
<style>
.lesson-header {
    background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
    color: #065f46;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.lesson-detail-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid #e5e7eb;
}

.lesson-detail-item:last-child {
    border-bottom: none;
}

.lesson-detail-label {
    font-weight: 600;
    color: #374151;
}

.lesson-detail-value {
    color: #6b7280;
}

.status-badge {
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    font-weight: 500;
}

.status-assigned {
    background: #10b981;
    color: white;
}

.status-draft {
    background: #6b7280;
    color: white;
}

.payment-paid {
    color: #10b981;
    font-weight: 600;
}

.payment-unpaid {
    color: #f59e0b;
    font-weight: 600;
}

.section-divider {
    border-top: 2px solid #e5e7eb;
    margin: 2rem 0;
    padding-top: 2rem;
}

.form-section {
    background: #f9fafb;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 1.5rem;
}

.form-section h3 {
    color: #065f46;
    font-weight: 600;
    margin-bottom: 1rem;
    border-bottom: 2px solid #10b981;
    padding-bottom: 0.5rem;
}

.zoom-link-field input {
    width: 100% !important;
    min-width: 500px !important;
    padding: 0.5rem !important;
    border: 1px solid #d1d5db !important;
    border-radius: 4px !important;
}

/* Make content fields full width */
.form-section textarea,
.form-section .django-ckeditor-widget,
.form-section .django-ckeditor-5,
.form-section .cke,
.form-section .ck-editor {
    width: 100% !important;
    min-width: 100% !important;
}

.form-section .cke_contents,
.form-section .ck-editor__editable {
    min-height: 200px !important;
}

/* Document file display improvements */
.form-section input[type="file"] {
    word-break: break-all;
    white-space: normal;
    overflow-wrap: break-word;
}

.document-file-display {
    word-break: break-all;
    white-space: normal;
    overflow-wrap: break-word;
    max-width: 100%;
    display: block;
}

.inline-form {
    background: white;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.inline-form.empty {
    background: #f3f4f6;
    border-style: dashed;
}

.delete-checkbox {
    color: #dc2626;
}

.btn-add-form {
    background: #065f46;
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
}

.btn-add-form:hover {
    background: #047857;
}
</style>
{% endblock %}

{% block content %}
<div class="container mx-auto p-6 max-w-6xl">
    <!-- Lesson Header with Details -->
    <div class="lesson-header">
        <div class="flex justify-between items-start">
            <div>
                <h1 class="text-3xl font-bold mb-4">{{ lesson.subject.subject }} | {{ lesson.student.get_full_name|default:lesson.student.username|default:"Unknown Student" }}</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Lesson Date:</span>
                            <span class="lesson-detail-value text-white">{{ lesson.lesson_date|date:"M j, Y" }} {{ lesson.lesson_time|time:"g:i A" }}</span>
                        </div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Fee:</span>
                            <span class="lesson-detail-value text-white">¬£{{ lesson.fee|floatformat:2|default:"Not set" }}</span>
                        </div>
                    </div>
                    <div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Duration:</span>
                            <span class="lesson-detail-value text-white">{{ lesson.duration_in_minutes }} mins</span>
                        </div>
                        <div class="lesson-detail-item">
                            <span class="lesson-detail-label">Status:</span>
                            <span class="status-badge {% if lesson.status == 'Assigned' %}status-assigned{% else %}status-draft{% endif %}">{{ lesson.status }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <div class="text-sm opacity-80 mb-2">Payment Status</div>
                <div class="{% if lesson.payment_status == 'Paid' %}payment-paid{% else %}payment-unpaid{% endif %} text-lg font-bold">
                    {{ lesson.payment_status }}
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <div class="flex gap-4 mb-6">
        <a href="{% url 'private_teaching:calendar' %}" class="btn btn-outline">‚Üê Back to Calendar</a>
    </div>

    <!-- Edit Form -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}
        
        <!-- Basic Settings -->
        <div class="form-section">
            <h3>Lesson Settings</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Location</label>
                    {{ form.location }}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Attendance</label>
                    {{ form.attendance }}
                </div>
            </div>
            <div class="mt-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Zoom Link</label>
                <div class="zoom-link-field">
                    {{ form.zoom_link }}
                </div>
                <small class="text-gray-500">Can be set by teacher in teacher settings or edited here</small>
            </div>
        </div>

        <!-- Lesson Content -->
        <div class="form-section">
            <h3>Lesson Content</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Lesson Content</label>
                {{ form.lesson_content }}
            </div>
        </div>

        <!-- Teacher Notes -->
        <div class="form-section">
            <h3>Teacher Notes</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Teacher Notes</label>
                {{ form.teacher_notes }}
            </div>
        </div>

        <!-- Homework -->
        <div class="form-section">
            <h3>Homework</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Homework</label>
                {{ form.homework }}
            </div>
        </div>

        <!-- Private Notes -->
        <div class="form-section">
            <h3>Private Notes</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Private Notes</label>
                {{ form.private_note }}
                <small class="text-gray-500">Not visible to students</small>
            </div>
        </div>

        <!-- Status -->
        <div class="form-section">
            <h3>Publication Status</h3>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                {{ form.status }}
                <small class="text-gray-500">Draft = not visible to student, Assigned = visible to student</small>
            </div>
        </div>

        <!-- Document Uploads -->
        <div class="form-section">
            <h3>Document Uploads</h3>
            {{ named_formsets.documents.management_form }}
            <div id="document-forms">
                {% for form in named_formsets.documents %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="font-medium mb-3">Document #{{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="font-medium mb-3 text-gray-500">New Document</h4>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                                {{ form.title }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Document File</label>
                                {% if form.instance.pk and form.instance.document %}
                                    <div class="document-file-display mb-2">
                                        <a href="{{ form.instance.document.url }}" target="_blank" class="text-blue-600 hover:text-blue-800">
                                            {{ form.instance.document.name|cut:"lesson_documents/" }}
                                        </a>
                                    </div>
                                    {{ form.document.as_hidden }}
                                    <input type="file" name="{{ form.document.html_name }}" id="{{ form.document.id_for_label }}" class="form-control">
                                {% else %}
                                    {{ form.document }}
                                {% endif %}
                            </div>
                        </div>
                        
                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox cursor-pointer">Delete this document</label>
                            </div>
                        {% endif %}
                        
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-document" class="btn-add-form mt-3">+ Add Document</button>
        </div>

        <!-- URL Attachments -->
        <div class="form-section">
            <h3>URL Attachments</h3>
            {{ named_formsets.lesson_attached_urls.management_form }}
            <div id="url-forms">
                {% for form in named_formsets.lesson_attached_urls %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="font-medium mb-3">URL #{{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="font-medium mb-3 text-gray-500">New URL</h4>
                        {% endif %}
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                                {{ form.name }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                                {{ form.url }}
                            </div>
                        </div>
                        
                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox">Delete this URL</label>
                            </div>
                        {% endif %}
                        
                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-url" class="btn-add-form mt-3">+ Add URL</button>
        </div>

        <!-- Playalong Pieces -->
        <div class="form-section">
            <h3>üéµ Playalong Pieces</h3>
            <p class="text-sm text-gray-600 mb-4">Add interactive rhythm exercises and playalong content for this lesson. Students can access these when the lesson status is "Assigned".</p>
            {{ named_formsets.pieces.management_form }}
            <div id="piece-forms">
                {% for form in named_formsets.pieces %}
                    <div class="inline-form {% if form.instance.pk %}{% else %}empty{% endif %}">
                        {% if form.instance.pk %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">Piece {{ forloop.counter }}</h4>
                        {% else %}
                            <h4 class="text-sm font-semibold text-gray-700 mb-2">New Piece</h4>
                        {% endif %}

                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Piece</label>
                                {{ form.piece }}
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                                {{ form.order }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                            {{ form.instructions }}
                            <small class="text-gray-500">Optional: Add specific guidance for this piece in this lesson</small>
                        </div>
                        <div class="flex gap-6 mb-3">
                            <div class="flex items-center gap-2">
                                {{ form.is_visible }}
                                <label for="{{ form.is_visible.id_for_label }}" class="text-sm">Visible to student</label>
                            </div>
                            <div class="flex items-center gap-2">
                                {{ form.is_optional }}
                                <label for="{{ form.is_optional.id_for_label }}" class="text-sm">Mark as optional</label>
                            </div>
                        </div>

                        {% if form.instance.pk %}
                            <div class="mt-3 flex items-center gap-2">
                                {{ form.DELETE }}
                                <label for="{{ form.DELETE.id_for_label }}" class="text-sm text-red-600 delete-checkbox">Delete this piece</label>
                            </div>
                        {% endif %}

                        {% for hidden in form.hidden_fields %}
                            {{ hidden }}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <button type="button" id="add-piece" class="btn-add-form mt-3">+ Add Piece</button>
            <a href="{% url 'audioplayer:piece_list' %}" target="_blank" class="btn btn-outline mt-3 ml-2">Manage Piece Library</a>
        </div>

        <!-- Form Actions -->
        <div class="flex gap-4 pt-6 border-t border-gray-200">
            <button type="submit" class="btn btn-primary">Save Lesson</button>
            <a href="{% url 'lessons:lesson_detail' lesson.pk %}" class="btn btn-outline">Cancel</a>
        </div>
    </form>
</div>

<script>
// Handle form errors and dynamic formsets
document.addEventListener('DOMContentLoaded', function() {
    console.log('Lesson edit form loaded');
    
    // Add visual feedback for delete checkboxes
    document.querySelectorAll('input[name*="DELETE"]').forEach(function(checkbox) {
        checkbox.addEventListener('change', function() {
            const container = this.closest('.inline-form');
            if (this.checked) {
                container.style.opacity = '0.5';
                container.style.textDecoration = 'line-through';
                console.log('Marked for deletion:', this.name);
            } else {
                container.style.opacity = '1';
                container.style.textDecoration = 'none';
                console.log('Unmarked for deletion:', this.name);
            }
        });
    });
    
    // Function to add new document form
    document.getElementById('add-document').addEventListener('click', function() {
        const container = document.getElementById('document-forms');
        const totalForms = document.querySelector('#id_documents-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);
        
        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="font-medium mb-3">New Document</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Title</label>
                        <input type="text" name="documents-${formIdx}-title" id="id_documents-${formIdx}-title" class="form-control">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Document File</label>
                        <input type="file" name="documents-${formIdx}-document" id="id_documents-${formIdx}-document" class="form-control">
                    </div>
                </div>
                <input type="hidden" name="documents-${formIdx}-id" id="id_documents-${formIdx}-id">
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });
    
    // Function to add new URL form
    document.getElementById('add-url').addEventListener('click', function() {
        const container = document.getElementById('url-forms');
        const totalForms = document.querySelector('#id_lesson_attached_urls-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);
        
        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="font-medium mb-3">New URL</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                        <input type="text" name="lesson_attached_urls-${formIdx}-name" id="id_lesson_attached_urls-${formIdx}-name" class="form-control">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">URL</label>
                        <input type="url" name="lesson_attached_urls-${formIdx}-url" id="id_lesson_attached_urls-${formIdx}-url" class="form-control">
                    </div>
                </div>
                <input type="hidden" name="lesson_attached_urls-${formIdx}-id" id="id_lesson_attached_urls-${formIdx}-id">
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });

    // Function to add new piece form
    document.getElementById('add-piece').addEventListener('click', function() {
        const container = document.getElementById('piece-forms');
        const totalForms = document.querySelector('#id_pieces-TOTAL_FORMS');
        const formIdx = parseInt(totalForms.value);

        // Create new form HTML
        const newFormHtml = `
            <div class="inline-form">
                <h4 class="text-sm font-semibold text-gray-700 mb-2">New Piece</h4>
                <div class="grid grid-cols-2 gap-4 mb-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Piece</label>
                        <select name="pieces-${formIdx}-piece" id="id_pieces-${formIdx}-piece" class="form-control">
                            <option value="">---------</option>
                            {% for piece in pieces %}
                            <option value="{{ piece.id }}">{{ piece.title }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Display Order</label>
                        <input type="number" name="pieces-${formIdx}-order" id="id_pieces-${formIdx}-order" value="0" class="form-control">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Lesson-Specific Instructions</label>
                    <textarea name="pieces-${formIdx}-instructions" id="id_pieces-${formIdx}-instructions" rows="3" class="form-control"></textarea>
                    <small class="text-gray-500">Optional: Add specific guidance for this piece in this lesson</small>
                </div>
                <div class="flex gap-6 mb-3">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="pieces-${formIdx}-is_visible" id="id_pieces-${formIdx}-is_visible" checked class="form-checkbox">
                        <label for="id_pieces-${formIdx}-is_visible" class="text-sm">Visible to student</label>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" name="pieces-${formIdx}-is_optional" id="id_pieces-${formIdx}-is_optional" class="form-checkbox">
                        <label for="id_pieces-${formIdx}-is_optional" class="text-sm">Mark as optional</label>
                    </div>
                </div>
                <input type="hidden" name="pieces-${formIdx}-id" id="id_pieces-${formIdx}-id">
            </div>
        `;

        container.insertAdjacentHTML('beforeend', newFormHtml);
        totalForms.value = formIdx + 1;
    });
});
</script>
{% endblock %}