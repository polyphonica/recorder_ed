{% extends 'base.html' %}
{% load static %}

{% block title %}Music Notation Editor - Proof of Concept{% endblock %}

{% block extra_head %}
<style>
    .notation-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    .editor-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        padding: 30px;
        margin-bottom: 20px;
    }

    .toolbar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
        align-items: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .toolbar-group {
        display: flex;
        gap: 5px;
        align-items: center;
        padding-right: 15px;
        border-right: 2px solid #dee2e6;
    }

    .toolbar-group:last-child {
        border-right: none;
    }

    .toolbar-label {
        font-weight: 600;
        margin-right: 8px;
        color: #495057;
        font-size: 14px;
    }

    .note-btn {
        padding: 8px 16px;
        border: 2px solid #dee2e6;
        background: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 14px;
    }

    .note-btn.small {
        padding: 6px 12px;
        font-size: 12px;
    }

    .note-btn:hover {
        background: #e9ecef;
        border-color: #adb5bd;
    }

    .note-btn.active {
        background: #4a90e2;
        color: white;
        border-color: #4a90e2;
    }

    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
        font-size: 14px;
    }

    .btn-clear {
        background: #dc3545;
        color: white;
    }

    .btn-clear:hover {
        background: #c82333;
    }

    .btn-export {
        background: #28a745;
        color: white;
    }

    .btn-export:hover {
        background: #218838;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn-info {
        background: #17a2b8;
        color: white;
    }

    .btn-info:hover {
        background: #138496;
    }

    #notation-output {
        border: 2px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        background: #ffffff;
        min-height: 200px;
        overflow-x: auto;
    }

    .instructions {
        background: #e7f3ff;
        border-left: 4px solid #4a90e2;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
    }

    .instructions h3 {
        margin-top: 0;
        color: #2c5aa0;
        font-size: 18px;
    }

    .instructions ul {
        margin-bottom: 0;
        padding-left: 20px;
    }

    .instructions li {
        margin-bottom: 8px;
        line-height: 1.6;
    }

    .note-data-output {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 15px;
        font-family: monospace;
        font-size: 12px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 20px;
    }

    .octave-section {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .pitch-row {
        display: flex;
        gap: 5px;
    }

    .chord-builder {
        background: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 8px;
        padding: 12px;
        margin-top: 15px;
        display: none;
    }

    .chord-builder.active {
        display: block;
    }

    .chord-notes-display {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 8px;
    }

    .chord-note-badge {
        background: #4a90e2;
        color: white;
        padding: 4px 12px;
        border-radius: 4px;
        font-size: 13px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
    }

    .chord-note-badge .remove-note {
        cursor: pointer;
        font-weight: bold;
        opacity: 0.8;
    }

    .chord-note-badge .remove-note:hover {
        opacity: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="notation-container">
    <div class="mb-6">
        <h1 class="text-4xl font-bold mb-2">Music Notation Editor - Enhanced</h1>
        <p class="text-base-content/70">Proof of Concept - VexFlow Interactive Editor with Advanced Features</p>
    </div>

    <div class="instructions">
        <h3>How to Use:</h3>
        <ul>
            <li><strong>Select Clef:</strong> Choose treble, bass, or alto clef</li>
            <li><strong>Select Duration:</strong> Click on whole, half, quarter, or eighth note</li>
            <li><strong>Select Pitch & Octave:</strong> Click pitch buttons organized by octave</li>
            <li><strong>Add Accidentals:</strong> Click sharp (‚ôØ), flat (‚ô≠), or natural (‚ôÆ) before adding note</li>
            <li><strong>Single Notes:</strong> Click "Add Note" to add one note at a time</li>
            <li><strong>Chords:</strong> Enable "Chord Mode", add multiple pitches, then click "Finish Chord"</li>
            <li><strong>Add Rest/Barline:</strong> Insert rests or measure separators</li>
            <li><strong>Remove Last:</strong> Delete the most recent note/rest/barline</li>
            <li><strong>Clear All:</strong> Start over with empty staff</li>
        </ul>
    </div>

    <div class="editor-card">
        <!-- Toolbar Row 1: Clef and Duration -->
        <div class="toolbar">
            <!-- Clef Selection -->
            <div class="toolbar-group">
                <span class="toolbar-label">Clef:</span>
                <button class="note-btn active" data-clef="treble" onclick="selectClef('treble', this)">
                    <span style="font-size: 20px;">ùÑû</span> Treble
                </button>
                <button class="note-btn" data-clef="bass" onclick="selectClef('bass', this)">
                    <span style="font-size: 20px;">ùÑ¢</span> Bass
                </button>
                <button class="note-btn" data-clef="alto" onclick="selectClef('alto', this)">
                    <span style="font-size: 20px;">ùÑ°</span> Alto
                </button>
            </div>

            <!-- Note Duration -->
            <div class="toolbar-group">
                <span class="toolbar-label">Duration:</span>
                <button class="note-btn active" data-duration="w" onclick="selectDuration('w', this)">
                    <span style="font-size: 20px;">ùÖù</span> Whole
                </button>
                <button class="note-btn" data-duration="h" onclick="selectDuration('h', this)">
                    <span style="font-size: 20px;">ùÖóùÖ•</span> Half
                </button>
                <button class="note-btn" data-duration="q" onclick="selectDuration('q', this)">
                    <span style="font-size: 20px;">ùÖòùÖ•</span> Quarter
                </button>
                <button class="note-btn" data-duration="8" onclick="selectDuration('8', this)">
                    <span style="font-size: 20px;">ùÖòùÖ•ùÖÆ</span> Eighth
                </button>
            </div>

            <!-- Accidentals -->
            <div class="toolbar-group">
                <span class="toolbar-label">Accidental:</span>
                <button class="note-btn" data-accidental="none" onclick="selectAccidental('none', this)">
                    None
                </button>
                <button class="note-btn" data-accidental="#" onclick="selectAccidental('#', this)">
                    <span style="font-size: 18px;">‚ôØ</span> Sharp
                </button>
                <button class="note-btn" data-accidental="b" onclick="selectAccidental('b', this)">
                    <span style="font-size: 18px;">‚ô≠</span> Flat
                </button>
                <button class="note-btn" data-accidental="n" onclick="selectAccidental('n', this)">
                    <span style="font-size: 18px;">‚ôÆ</span> Natural
                </button>
            </div>
        </div>

        <!-- Toolbar Row 2: Pitches by Octave -->
        <div class="toolbar">
            <div class="toolbar-group">
                <span class="toolbar-label">Pitches:</span>
                <div class="octave-section">
                    <div class="pitch-row">
                        <small style="width: 40px; text-align: right; margin-right: 8px; color: #6c757d;">Oct 6:</small>
                        <button class="note-btn small" data-pitch="c/6" onclick="selectPitch('c/6', this)">C</button>
                        <button class="note-btn small" data-pitch="d/6" onclick="selectPitch('d/6', this)">D</button>
                        <button class="note-btn small" data-pitch="e/6" onclick="selectPitch('e/6', this)">E</button>
                        <button class="note-btn small" data-pitch="f/6" onclick="selectPitch('f/6', this)">F</button>
                        <button class="note-btn small" data-pitch="g/6" onclick="selectPitch('g/6', this)">G</button>
                        <button class="note-btn small" data-pitch="a/6" onclick="selectPitch('a/6', this)">A</button>
                        <button class="note-btn small" data-pitch="b/6" onclick="selectPitch('b/6', this)">B</button>
                    </div>
                    <div class="pitch-row">
                        <small style="width: 40px; text-align: right; margin-right: 8px; color: #6c757d;">Oct 5:</small>
                        <button class="note-btn small" data-pitch="c/5" onclick="selectPitch('c/5', this)">C</button>
                        <button class="note-btn small" data-pitch="d/5" onclick="selectPitch('d/5', this)">D</button>
                        <button class="note-btn small" data-pitch="e/5" onclick="selectPitch('e/5', this)">E</button>
                        <button class="note-btn small" data-pitch="f/5" onclick="selectPitch('f/5', this)">F</button>
                        <button class="note-btn small" data-pitch="g/5" onclick="selectPitch('g/5', this)">G</button>
                        <button class="note-btn small" data-pitch="a/5" onclick="selectPitch('a/5', this)">A</button>
                        <button class="note-btn small" data-pitch="b/5" onclick="selectPitch('b/5', this)">B</button>
                    </div>
                    <div class="pitch-row">
                        <small style="width: 40px; text-align: right; margin-right: 8px; color: #6c757d;">Oct 4:</small>
                        <button class="note-btn small" data-pitch="c/4" onclick="selectPitch('c/4', this)">C</button>
                        <button class="note-btn small active" data-pitch="d/4" onclick="selectPitch('d/4', this)">D</button>
                        <button class="note-btn small" data-pitch="e/4" onclick="selectPitch('e/4', this)">E</button>
                        <button class="note-btn small" data-pitch="f/4" onclick="selectPitch('f/4', this)">F</button>
                        <button class="note-btn small" data-pitch="g/4" onclick="selectPitch('g/4', this)">G</button>
                        <button class="note-btn small" data-pitch="a/4" onclick="selectPitch('a/4', this)">A</button>
                        <button class="note-btn small" data-pitch="b/4" onclick="selectPitch('b/4', this)">B</button>
                    </div>
                    <div class="pitch-row">
                        <small style="width: 40px; text-align: right; margin-right: 8px; color: #6c757d;">Oct 3:</small>
                        <button class="note-btn small" data-pitch="c/3" onclick="selectPitch('c/3', this)">C</button>
                        <button class="note-btn small" data-pitch="d/3" onclick="selectPitch('d/3', this)">D</button>
                        <button class="note-btn small" data-pitch="e/3" onclick="selectPitch('e/3', this)">E</button>
                        <button class="note-btn small" data-pitch="f/3" onclick="selectPitch('f/3', this)">F</button>
                        <button class="note-btn small" data-pitch="g/3" onclick="selectPitch('g/3', this)">G</button>
                        <button class="note-btn small" data-pitch="a/3" onclick="selectPitch('a/3', this)">A</button>
                        <button class="note-btn small" data-pitch="b/3" onclick="selectPitch('b/3', this)">B</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toolbar Row 3: Actions -->
        <div class="toolbar">
            <!-- Chord Mode Toggle -->
            <div class="toolbar-group">
                <button class="note-btn" id="chord-mode-btn" onclick="toggleChordMode()">
                    <i class="fas fa-layer-group"></i> Chord Mode
                </button>
            </div>

            <!-- Add Elements -->
            <div class="toolbar-group">
                <button class="action-btn btn-export" onclick="addNote()">
                    <i class="fas fa-plus-circle"></i> <span id="add-note-text">Add Note</span>
                </button>
                <button class="action-btn btn-export" onclick="addRest()">
                    <i class="fas fa-pause"></i> Add Rest
                </button>
                <button class="action-btn btn-info" onclick="addBarline()">
                    <i class="fas fa-grip-lines-vertical"></i> Add Barline
                </button>
            </div>

            <!-- Edit Actions -->
            <div class="toolbar-group">
                <button class="action-btn btn-warning" onclick="removeLast()">
                    <i class="fas fa-undo"></i> Remove Last
                </button>
                <button class="action-btn btn-clear" onclick="clearNotation()">
                    <i class="fas fa-trash"></i> Clear All
                </button>
            </div>

            <!-- Export -->
            <div class="toolbar-group">
                <button class="action-btn btn-export" onclick="exportJSON()">
                    <i class="fas fa-file-export"></i> Export JSON
                </button>
            </div>
        </div>

        <!-- Chord Builder (appears when in chord mode) -->
        <div id="chord-builder" class="chord-builder">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong><i class="fas fa-layer-group"></i> Building Chord:</strong>
                    <span id="chord-count" style="margin-left: 8px; color: #856404;">0 notes</span>
                </div>
                <button class="action-btn btn-export" onclick="finishChord()">
                    <i class="fas fa-check"></i> Finish Chord
                </button>
            </div>
            <div id="chord-notes-display" class="chord-notes-display"></div>
        </div>

        <!-- Notation Display -->
        <div id="notation-output"></div>

        <!-- Data Output (hidden by default) -->
        <div id="data-output" class="note-data-output" style="display: none;">
            <strong>JSON Data:</strong>
            <pre id="json-data"></pre>
        </div>
    </div>

    <div class="mt-6 text-center">
        <a href="{% url 'private_teaching:teacher_dashboard' %}" class="btn btn-outline">
            <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- VexFlow Library from CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/vexflow/4.2.2/vexflow-min.js"></script>

<script>
const VF = Vex.Flow;

// Editor state
let selectedClef = 'treble';
let selectedDuration = 'w';
let selectedPitch = 'd/4';
let selectedAccidental = 'none';
let notes = [];

// Chord mode state
let chordMode = false;
let currentChord = [];

// VexFlow objects
let renderer, context, stave;

// Initialize the notation display
function initNotation() {
    const outputDiv = document.getElementById('notation-output');
    outputDiv.innerHTML = '';

    renderer = new VF.Renderer(outputDiv, VF.Renderer.Backends.SVG);
    renderer.resize(1200, 200);
    context = renderer.getContext();

    stave = new VF.Stave(10, 40, 1150);
    stave.addClef(selectedClef);
    stave.addTimeSignature('4/4');
    stave.setContext(context).draw();

    if (notes.length > 0) {
        renderNotes();
    }
}

// Select clef
function selectClef(clef, button) {
    selectedClef = clef;

    document.querySelectorAll('[data-clef]').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');

    renderNotes();
}

// Select duration
function selectDuration(duration, button) {
    selectedDuration = duration;

    document.querySelectorAll('[data-duration]').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
}

// Select pitch
function selectPitch(pitch, button) {
    selectedPitch = pitch;

    document.querySelectorAll('[data-pitch]').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
}

// Select accidental
function selectAccidental(accidental, button) {
    selectedAccidental = accidental;

    document.querySelectorAll('[data-accidental]').forEach(btn => {
        btn.classList.remove('active');
    });
    button.classList.add('active');
}

// Toggle chord mode
function toggleChordMode() {
    chordMode = !chordMode;
    const chordModeBtn = document.getElementById('chord-mode-btn');
    const chordBuilder = document.getElementById('chord-builder');
    const addNoteText = document.getElementById('add-note-text');

    if (chordMode) {
        chordModeBtn.classList.add('active');
        chordBuilder.classList.add('active');
        addNoteText.textContent = 'Add to Chord';
        currentChord = [];
        updateChordDisplay();
    } else {
        chordModeBtn.classList.remove('active');
        chordBuilder.classList.remove('active');
        addNoteText.textContent = 'Add Note';
        currentChord = [];
    }
}

// Update chord display
function updateChordDisplay() {
    const display = document.getElementById('chord-notes-display');
    const countSpan = document.getElementById('chord-count');

    countSpan.textContent = `${currentChord.length} note${currentChord.length !== 1 ? 's' : ''}`;

    display.innerHTML = '';
    currentChord.forEach((chordNote, index) => {
        const badge = document.createElement('div');
        badge.className = 'chord-note-badge';

        let noteText = chordNote.pitch.toUpperCase().replace('/', '');
        if (chordNote.accidental && chordNote.accidental !== 'none') {
            const accSymbol = chordNote.accidental === '#' ? '‚ôØ' :
                            chordNote.accidental === 'b' ? '‚ô≠' : '‚ôÆ';
            noteText += accSymbol;
        }

        badge.innerHTML = `
            <span>${noteText}</span>
            <span class="remove-note" onclick="removeFromChord(${index})">√ó</span>
        `;
        display.appendChild(badge);
    });
}

// Remove a note from current chord
function removeFromChord(index) {
    currentChord.splice(index, 1);
    updateChordDisplay();
}

// Add a note (modified to handle chord mode)
function addNote() {
    if (chordMode) {
        // Add to current chord
        currentChord.push({
            pitch: selectedPitch,
            accidental: selectedAccidental
        });
        updateChordDisplay();
    } else {
        // Add single note directly
        const noteData = {
            type: 'note',
            keys: [selectedPitch],
            duration: selectedDuration
        };

        // Add accidental if selected
        if (selectedAccidental !== 'none') {
            noteData.accidental = selectedAccidental;
        }

        notes.push(noteData);
        renderNotes();
    }
}

// Finish chord and add to staff
function finishChord() {
    if (currentChord.length === 0) {
        alert('Please add at least one note to the chord first.');
        return;
    }

    // Sort chord notes from lowest to highest pitch for proper display
    const sortedChord = [...currentChord].sort((a, b) => {
        const getPitchValue = (pitch) => {
            const [note, octave] = pitch.split('/');
            const noteValues = {c: 0, d: 1, e: 2, f: 3, g: 4, a: 5, b: 6};
            return parseInt(octave) * 7 + noteValues[note];
        };
        return getPitchValue(a.pitch) - getPitchValue(b.pitch);
    });

    const noteData = {
        type: 'note',
        keys: sortedChord.map(n => n.pitch),
        duration: selectedDuration,
        accidentals: sortedChord.map(n => n.accidental !== 'none' ? n.accidental : null)
    };

    notes.push(noteData);

    // Reset chord mode
    currentChord = [];
    updateChordDisplay();
    renderNotes();
}

// Add a rest
function addRest() {
    notes.push({
        type: 'rest',
        keys: ['b/4'],
        duration: selectedDuration + 'r'
    });

    renderNotes();
}

// Add a barline
function addBarline() {
    notes.push({
        type: 'barline'
    });

    renderNotes();
}

// Remove last element
function removeLast() {
    if (notes.length > 0) {
        notes.pop();
        renderNotes();
    }
}

// Render all notes
function renderNotes() {
    const outputDiv = document.getElementById('notation-output');
    outputDiv.innerHTML = '';

    renderer = new VF.Renderer(outputDiv, VF.Renderer.Backends.SVG);
    renderer.resize(1200, 200);
    context = renderer.getContext();

    stave = new VF.Stave(10, 40, 1150);
    stave.addClef(selectedClef);
    stave.addTimeSignature('4/4');
    stave.setContext(context).draw();

    if (notes.length === 0) return;

    try {
        // Convert all items to VexFlow notes, including barlines
        const vfNotes = notes.map(noteData => {
            if (noteData.type === 'barline') {
                // Create a barline using BarNote
                return new VF.BarNote();
            } else {
                // Create regular note or rest (handles both single notes and chords)
                const note = new VF.StaveNote({
                    keys: noteData.keys,
                    duration: noteData.duration
                });

                // Add accidentals
                if (noteData.accidental) {
                    // Single note with one accidental
                    note.addModifier(new VF.Accidental(noteData.accidental), 0);
                } else if (noteData.accidentals && Array.isArray(noteData.accidentals)) {
                    // Chord with multiple accidentals
                    noteData.accidentals.forEach((acc, index) => {
                        if (acc) {
                            note.addModifier(new VF.Accidental(acc), index);
                        }
                    });
                }

                return note;
            }
        });

        if (vfNotes.length === 0) return;

        const voice = new VF.Voice({ num_beats: 4, beat_value: 4 });
        voice.setMode(VF.Voice.Mode.SOFT);
        voice.addTickables(vfNotes);

        const formatter = new VF.Formatter();
        formatter.joinVoices([voice]).format([voice], 1100);
        voice.draw(context, stave);

    } catch (error) {
        console.error('Error rendering notes:', error);
        alert('Error rendering notes: ' + error.message);
    }
}

// Clear all notes
function clearNotation() {
    if (confirm('Are you sure you want to clear all notes?')) {
        notes = [];
        initNotation();
        document.getElementById('data-output').style.display = 'none';
    }
}

// Export notation as JSON
function exportJSON() {
    const dataOutput = document.getElementById('data-output');
    const jsonData = document.getElementById('json-data');

    const exportData = {
        clef: selectedClef,
        notes: notes
    };

    jsonData.textContent = JSON.stringify(exportData, null, 2);
    dataOutput.style.display = 'block';
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    initNotation();
});
</script>
{% endblock %}
