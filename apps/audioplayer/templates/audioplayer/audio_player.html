{% extends "base.html" %}
{% load static %}

{% block title %}{% if is_library_player %}{{ title }}{% elif is_private_lesson %}Playalong: {{ lesson.subject.subject }}{% else %}Playalong: {{ lesson.lesson_title }}{% endif %} - {{ block.super }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'audioplayer/css/styles.css' %}">
<!-- Waveform Playlist v4 CDN -->
<script src="https://cdn.jsdelivr.net/npm/waveform-playlist@4.3.3/build/waveform-playlist.var.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/waveform-playlist@4.3.3/styles/playlist.css">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Breadcrumbs -->
    <nav class="breadcrumbs text-sm mb-6">
        {% if is_library_player %}
            <a href="{% url 'audioplayer:library' %}" class="text-primary hover:underline">Play-Along Library</a>
            <span class="mx-2">›</span>
            <span class="text-base-content/70">{{ piece.title }}</span>
        {% elif is_private_lesson %}
            <a href="{% url 'private_teaching:calendar' %}" class="text-primary hover:underline">My Calendar</a>
            <span class="mx-2">›</span>
            <a href="{% url 'lessons:lesson_detail' lesson.pk %}" class="text-primary hover:underline">
                {{ lesson.subject.subject }} - {{ lesson.lesson_date }}
            </a>
            <span class="mx-2">›</span>
            <span class="text-base-content/70">Playalong</span>
        {% else %}
            <a href="{% url 'courses:list' %}" class="text-primary hover:underline">Courses</a>
            <span class="mx-2">›</span>
            <a href="{% url 'courses:detail' slug=lesson.topic.course.slug %}" class="text-primary hover:underline">
                {{ lesson.topic.course.title }}
            </a>
            <span class="mx-2">›</span>
            <a href="{% url 'courses:view_lesson' lesson.id %}" class="text-primary hover:underline">
                {{ lesson.lesson_title }}
            </a>
            <span class="mx-2">›</span>
            <span class="text-base-content/70">Playalong</span>
        {% endif %}
    </nav>

    <!-- Header Section -->
    <section class="section-class mb-6">
        {% if is_library_player %}
            <h1 class="text-3xl font-bold mb-4">{{ piece.title }}</h1>
            {% if piece.composer %}
            <p class="text-lg text-base-content/70 mb-4">by {{ piece.composer.name }}</p>
            {% endif %}
        {% elif is_private_lesson %}
            <h1 class="text-3xl font-bold mb-4">Playalong: {{ lesson.subject.subject }}</h1>
        {% else %}
            <h1 class="text-3xl font-bold mb-4">Playalong: {{ lesson.lesson_title }}</h1>
        {% endif %}

        {% if piece_count > 0 %}
        <div class="alert alert-info mb-4">
            <i class="fas fa-info-circle"></i>
            <div>
                <p class="font-semibold">{{ piece_count }} piece{{ piece_count|pluralize }} available for practice</p>
                <p class="text-sm">The audio players will appear below once the page loads.</p>
            </div>
        </div>
        <p class="mb-4">Practice along with these interactive multi-track audio pieces.</p>
        <ul class="list-disc list-inside space-y-2">
            <li>Click the <strong>Play</strong> button to start the piece</li>
            <li>You will hear all tracks playing together</li>
            <li>Use <strong>Mute</strong> to silence individual tracks</li>
            <li>Use <strong>Solo</strong> to hear only specific tracks</li>
            <li>Adjust individual track volumes or the master volume</li>
            <li>Sheet music will appear below each piece or it can be printed from the lesson attachments section</li>
        </ul>
        {% else %}
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <p class="font-semibold">No playalong pieces available yet</p>
                <p class="text-sm">Your teacher hasn't added any playalong pieces to this lesson yet.</p>
            </div>
        </div>
        {% endif %}
    </section>

    <!-- Hidden inputs for JavaScript -->
    {% if is_library_player %}
    <input type="hidden" id="piece-id" value="{{ piece.id }}">
    <input type="hidden" id="is-library-player" value="true">
    {% else %}
    <input type="hidden" id="lesson-id" value="{{ lesson.id }}">
    <input type="hidden" id="is-private-lesson" value="{% if is_private_lesson %}true{% else %}false{% endif %}">
    {% endif %}

    <!-- Players Container (populated by JavaScript) -->
    <div id="players-container">
        {% if piece_count > 0 %}
        <div class="flex justify-center items-center py-12">
            <div class="loading loading-spinner loading-lg text-primary"></div>
            <span class="ml-4 text-lg">Loading audio players...</span>
        </div>
        {% endif %}
    </div>

    <!-- Back Button -->
    <div class="mt-8 mb-8 text-center">
        {% if is_library_player %}
            <a href="{% url 'audioplayer:library' %}"
               class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Library
            </a>
        {% elif is_private_lesson %}
            <a href="{% url 'lessons:lesson_detail' lesson.pk %}"
               class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Lesson
            </a>
        {% else %}
            <a href="{% url 'courses:view_lesson' lesson.id %}"
               class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>
                Back to Lesson
            </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'audioplayer/js/audio_player.js' %}?v=3"></script>
{% endblock %}
