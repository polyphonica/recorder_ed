{% extends "base.html" %}
{% load static %}

{% block title %}{% if object %}Edit{% else %}Create{% endif %} Product - Teacher Dashboard - {{ block.super }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'digital_products:teacher_dashboard' %}" class="text-blue-600 hover:underline mb-4 inline-block">
                ‚Üê Back to Dashboard
            </a>
            <h1 class="text-4xl font-bold text-gray-900">
                {% if object %}Edit Product{% else %}Create New Product{% endif %}
            </h1>
        </div>

        <!-- Form -->
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}

            <!-- Basic Information -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Basic Information</h2>

                <div class="space-y-4">
                    <!-- Title -->
                    <div>
                        <label for="id_title" class="block text-sm font-medium text-gray-700 mb-2">Product Title *</label>
                        {{ form.title }}
                        {% if form.title.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.title.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Short Description -->
                    <div>
                        <label for="id_short_description" class="block text-sm font-medium text-gray-700 mb-2">Short Description *</label>
                        {{ form.short_description }}
                        <p class="mt-1 text-sm text-gray-500">Brief summary (max 300 characters)</p>
                        {% if form.short_description.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.short_description.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Full Description -->
                    <div>
                        <label for="id_description" class="block text-sm font-medium text-gray-700 mb-2">Full Description</label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Categorization -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Categorization</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Category -->
                    <div>
                        <label for="id_category" class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        {{ form.category }}
                        {% if form.category.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Product Type -->
                    <div>
                        <label for="id_product_type" class="block text-sm font-medium text-gray-700 mb-2">Product Type *</label>
                        {{ form.product_type }}
                        {% if form.product_type.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.product_type.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Tags -->
                    <div class="md:col-span-2">
                        <label for="id_tags" class="block text-sm font-medium text-gray-700 mb-2">Tags</label>
                        {{ form.tags }}
                        <p class="mt-1 text-sm text-gray-500">Comma-separated (e.g., baroque, intermediate, ensemble)</p>
                        {% if form.tags.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.tags.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Pricing & Media -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Pricing & Media</h2>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Price -->
                    <div>
                        <label for="id_price" class="block text-sm font-medium text-gray-700 mb-2">Price (¬£) *</label>
                        {{ form.price }}
                        {% if form.price.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.price.errors.0 }}</p>
                        {% endif %}
                    </div>

                    <!-- Featured Image -->
                    <div>
                        <label for="id_featured_image" class="block text-sm font-medium text-gray-700 mb-2">Featured Image</label>
                        {{ form.featured_image }}
                        <p class="mt-1 text-sm text-gray-500">Recommended: 1200x800px</p>
                        {% if form.featured_image.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.featured_image.errors.0 }}</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Status</h2>

                <div>
                    <label for="id_status" class="block text-sm font-medium text-gray-700 mb-2">Publication Status *</label>
                    {{ form.status }}
                    <p class="mt-1 text-sm text-gray-500">Set to "Published" to make visible to students</p>
                    {% if form.status.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.status.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>

            <!-- Product Files -->
            {% if file_formset %}
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-900 mb-4">Product Files</h2>
                <p class="text-gray-600 mb-4">Upload files OR provide URLs (e.g., private YouTube videos) that students will access after purchase</p>

                {{ file_formset.management_form }}

                <div class="space-y-4">
                    {% for file_form in file_formset %}
                    <div class="border border-gray-300 rounded-lg p-4 {% if file_form.instance.pk %}bg-gray-50{% endif %}">
                        {{ file_form.id }}
                        {% if file_form.instance.pk %}
                        <div class="mb-2">
                            <span class="text-sm font-semibold text-gray-700">
                                Current: {{ file_form.instance.title }}
                                {% if file_form.instance.is_file %}
                                    (File: {{ file_form.instance.file.name }})
                                {% elif file_form.instance.is_url %}
                                    (URL: {{ file_form.instance.content_url }})
                                {% endif %}
                            </span>
                        </div>
                        {% endif %}

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Title -->
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Title *</label>
                                {{ file_form.title }}
                            </div>

                            <!-- File Upload -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    Upload File
                                    <span class="text-gray-500 font-normal">(max 50MB)</span>
                                </label>
                                {{ file_form.file }}
                            </div>

                            <!-- URL Input -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">
                                    OR Provide URL
                                    <span class="text-gray-500 font-normal">(YouTube, Vimeo, etc.)</span>
                                </label>
                                {{ file_form.content_url }}
                            </div>

                            <!-- Helper Text -->
                            <div class="md:col-span-2 text-sm text-gray-600 bg-blue-50 border border-blue-200 rounded p-2">
                                üí° <strong>Tip:</strong> You can provide a file, a URL, or both!
                                For example: a YouTube video tutorial + a PDF worksheet.
                            </div>

                            <!-- File Role -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">File Role *</label>
                                {{ file_form.file_role }}
                            </div>

                            <!-- Order -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Display Order</label>
                                {{ file_form.order }}
                            </div>

                            <!-- Delete Checkbox -->
                            {% if file_form.instance.pk %}
                            <div class="md:col-span-2 flex items-center">
                                {{ file_form.DELETE }}
                                <label for="{{ file_form.DELETE.id_for_label }}" class="ml-2 text-sm text-red-600">
                                    Delete this file
                                </label>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <p class="text-sm text-gray-500 mt-4">
                    <strong>Note:</strong> Use "Main" for the primary product content, "Preview" for sample/demo
                    content (publicly visible), and "Bonus" for additional content.
                </p>
            </div>
            {% endif %}

            <!-- Form Errors -->
            {% if form.errors or file_formset.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <p class="text-red-800 font-semibold mb-2">Please correct the following errors:</p>
                <ul class="list-disc list-inside text-red-700">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                        <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% if file_formset.errors %}
                    <li>Please check the file formset for errors</li>
                    {% endif %}
                </ul>
            </div>
            {% endif %}

            <!-- Action Buttons -->
            <div class="flex gap-4">
                <button type="submit" id="submitBtn"
                        class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition font-semibold">
                    {% if object %}Update Product{% else %}Create Product{% endif %}
                </button>
                <a href="{% url 'digital_products:teacher_dashboard' %}"
                   class="bg-gray-200 text-gray-800 px-8 py-3 rounded-lg hover:bg-gray-300 transition font-semibold">
                    Cancel
                </a>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Prevent double form submission
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const submitBtn = document.getElementById('submitBtn');

    if (form && submitBtn) {
        form.addEventListener('submit', function(e) {
            // Disable submit button to prevent double-clicks
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

            // Re-enable after 3 seconds in case of validation errors
            setTimeout(function() {
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    submitBtn.innerHTML = '{% if object %}Update Product{% else %}Create Product{% endif %}';
                }
            }, 3000);
        });
    }
});
</script>
{% endblock %}
