{% extends 'base.html' %}
{% load static %}

{% block title %}Review Application - Private Teaching{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <a href="{% url 'private_teaching:teacher_applications' %}" class="btn btn-ghost btn-sm mb-4">
            <i class="fas fa-arrow-left mr-2"></i>Back to Applications
        </a>
        <h1 class="text-4xl font-bold mb-2">Application from {{ application.student_name }}</h1>
        <p class="text-base-content/70">Review and manage this student application</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Content -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Status Management Card -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Application Status
                    </h2>

                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="update_status">

                        <div class="grid grid-cols-1 gap-4">
                            <!-- Current Status Display -->
                            <div class="alert {% if application.status == 'pending' %}alert-warning{% elif application.status == 'accepted' %}alert-success{% elif application.status == 'waitlist' %}alert-info{% else %}alert-error{% endif %}">
                                <i class="fas fa-info-circle"></i>
                                <span>
                                    <strong>Current Status:</strong> {{ application.get_status_display }}
                                    {% if application.status_changed_at %}
                                        <span class="text-sm">(Updated {{ application.status_changed_at|date:"M j, Y" }})</span>
                                    {% endif %}
                                </span>
                            </div>

                            <!-- Status Selection -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold">Change Status</span>
                                </label>
                                <select name="status" class="select select-bordered" required>
                                    <option value="">-- Select New Status --</option>
                                    <option value="accepted" {% if application.status == 'accepted' %}selected{% endif %}>
                                        ✓ Accept Student
                                    </option>
                                    <option value="waitlist" {% if application.status == 'waitlist' %}selected{% endif %}>
                                        ⏳ Add to Waiting List
                                    </option>
                                    <option value="declined" {% if application.status == 'declined' %}selected{% endif %}>
                                        ✗ Decline Application
                                    </option>
                                </select>
                            </div>

                            <!-- Teacher Notes (Required for decline/waitlist) -->
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-semibold">Notes / Message to Student</span>
                                    <span class="label-text-alt">Required for decline or waitlist</span>
                                </label>
                                <textarea
                                    name="teacher_notes"
                                    class="textarea textarea-bordered h-32"
                                    placeholder="Explain your decision to the student. For declined applications, please provide a reason. For waitlisted students, let them know when you might have space."
                                >{{ application.teacher_notes }}</textarea>
                                <label class="label">
                                    <span class="label-text-alt text-warning">
                                        <i class="fas fa-exclamation-triangle mr-1"></i>
                                        This message will be visible to the student
                                    </span>
                                </label>
                            </div>

                            <div class="card-actions justify-end">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save mr-2"></i>
                                    Update Status
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Message Thread -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h2 class="card-title text-2xl mb-4">
                        <i class="fas fa-comments mr-2"></i>
                        Conversation
                    </h2>

                    {% if app_messages %}
                        <div class="space-y-4 mb-6 max-h-96 overflow-y-auto">
                            {% for msg in app_messages %}
                                <div class="chat {% if msg.author == user %}chat-end{% else %}chat-start{% endif %}">
                                    <div class="chat-image avatar">
                                        <div class="w-10 rounded-full">
                                            <img src="{{ msg.author.profile.get_profile_image_url }}" alt="{{ msg.author.get_full_name }}">
                                        </div>
                                    </div>
                                    <div class="chat-header">
                                        {{ msg.author.get_full_name }}
                                        {% if msg.author == application.applicant %}
                                            <span class="badge badge-sm badge-info ml-1">Applicant</span>
                                        {% elif msg.author == user %}
                                            <span class="badge badge-sm badge-primary ml-1">You</span>
                                        {% endif %}
                                        <time class="text-xs opacity-50 ml-2">{{ msg.created_at|date:"M j, g:i A" }}</time>
                                    </div>
                                    <div class="chat-bubble {% if msg.author == user %}chat-bubble-primary{% endif %}">
                                        {{ msg.message|linebreaks }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="text-center py-8 text-base-content/70">
                            <i class="fas fa-comment-slash text-4xl mb-2"></i>
                            <p>No messages yet. Start the conversation with the applicant!</p>
                        </div>
                    {% endif %}

                    <!-- Send Message Form -->
                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="send_message">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text font-semibold">Send a message to applicant</span>
                            </label>
                            <textarea
                                name="message"
                                class="textarea textarea-bordered h-24"
                                placeholder="Ask questions or provide information about your teaching..."
                                required
                            ></textarea>
                        </div>
                        <div class="card-actions justify-end mt-4">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane mr-2"></i>
                                Send Message
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="space-y-6">
            <!-- Student/Applicant Info Card -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-3">
                        {% if application.is_child_application %}
                            <i class="fas fa-child mr-2"></i>
                            Child Student
                        {% else %}
                            <i class="fas fa-user mr-2"></i>
                            Student
                        {% endif %}
                    </h3>

                    <div class="space-y-3">
                        <div>
                            <div class="text-sm text-base-content/70">Student Name</div>
                            <div class="font-bold text-lg">{{ application.student_name }}</div>
                        </div>

                        {% if application.is_child_application %}
                            <div class="divider my-2"></div>
                            <div>
                                <div class="text-sm text-base-content/70">
                                    <i class="fas fa-user-shield mr-1"></i>Guardian / Parent
                                </div>
                                <div class="font-semibold">{{ application.applicant.get_full_name }}</div>
                            </div>
                            <div>
                                <div class="text-sm text-base-content/70">Guardian Email</div>
                                <div class="text-sm break-all">{{ application.applicant.email }}</div>
                            </div>
                            {% if application.applicant.profile.phone %}
                                <div>
                                    <div class="text-sm text-base-content/70">Guardian Phone</div>
                                    <div class="text-sm">{{ application.applicant.profile.phone }}</div>
                                </div>
                            {% endif %}
                            {% if application.child_profile.age %}
                                <div>
                                    <div class="text-sm text-base-content/70">Child's Age</div>
                                    <div class="text-sm">{{ application.child_profile.age }} years old</div>
                                </div>
                            {% endif %}
                        {% else %}
                            <div>
                                <div class="text-sm text-base-content/70">Email</div>
                                <div class="text-sm break-all">{{ application.applicant.email }}</div>
                            </div>
                            {% if application.applicant.profile.phone %}
                                <div>
                                    <div class="text-sm text-base-content/70">Phone</div>
                                    <div class="text-sm">{{ application.applicant.profile.phone }}</div>
                                </div>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Application Timeline -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-3">
                        <i class="fas fa-history mr-2"></i>
                        Timeline
                    </h3>

                    <div class="space-y-4">
                        <!-- Application Submitted -->
                        <div class="flex gap-3">
                            <div class="flex flex-col items-center">
                                <div class="w-3 h-3 rounded-full bg-primary"></div>
                                {% if application.status_changed_at %}
                                    <div class="w-0.5 h-full bg-primary"></div>
                                {% endif %}
                            </div>
                            <div class="flex-1 pb-4">
                                <div class="text-xs text-base-content/70 mb-1">{{ application.created_at|date:"M j, Y g:i A" }}</div>
                                <div class="font-semibold">Application Submitted</div>
                            </div>
                        </div>

                        {% if application.status_changed_at %}
                            <!-- Status Changed -->
                            <div class="flex gap-3">
                                <div class="flex flex-col items-center">
                                    <div class="w-3 h-3 rounded-full
                                        {% if application.status == 'accepted' %}bg-success
                                        {% elif application.status == 'waitlist' %}bg-info
                                        {% elif application.status == 'declined' %}bg-error
                                        {% else %}bg-warning{% endif %}">
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <div class="text-xs text-base-content/70 mb-1">{{ application.status_changed_at|date:"M j, Y g:i A" }}</div>
                                    <div class="font-semibold">{{ application.get_status_display }}</div>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card card-section shadow-xl">
                <div class="card-body">
                    <h3 class="card-title text-lg mb-3">Quick Actions</h3>
                    <div class="space-y-2">
                        <a href="mailto:{{ application.applicant.email }}" class="btn btn-outline btn-sm btn-block">
                            <i class="fas fa-envelope mr-2"></i>
                            Email Applicant
                        </a>
                        {% if application.applicant.profile.phone %}
                            <a href="tel:{{ application.applicant.profile.phone }}" class="btn btn-outline btn-sm btn-block">
                                <i class="fas fa-phone mr-2"></i>
                                Call Applicant
                            </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
