{% extends 'base.html' %}
{% load static %}

{% block title %}Availability Calendar - Private Teaching{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8" x-data="availabilityEditor()">
    {% csrf_token %}
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-4xl font-bold mb-2">Availability Calendar</h1>
                <p class="text-base-content/70">Manage your weekly schedule and booking preferences</p>
            </div>
            <a href="{% url 'private_teaching:teacher_dashboard' %}" class="btn btn-outline">
                ← Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Settings Section -->
    <div class="card card-section shadow-xl mb-6">
        <div class="card-body">
            <div class="flex items-center justify-between mb-4">
                <h2 class="card-title text-2xl">Booking Settings</h2>
                <div class="form-control">
                    <label class="label cursor-pointer gap-2">
                        <span class="label-text font-medium">Enable Availability Calendar</span>
                        <input type="checkbox" class="toggle toggle-primary"
                               x-model="settings.use_availability_calendar"
                               @change="saveSettings()">
                    </label>
                </div>
            </div>

            <template x-if="settings.use_availability_calendar">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Buffer Minutes -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Buffer Time (minutes)</span>
                        </label>
                        <input type="number" class="input input-bordered"
                               x-model.number="settings.buffer_minutes"
                               min="0" max="60" step="5"
                               @change="saveSettings()">
                        <label class="label">
                            <span class="label-text-alt">Break time between lessons</span>
                        </label>
                    </div>

                    <!-- Min Booking Notice -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Minimum Notice (hours)</span>
                        </label>
                        <input type="number" class="input input-bordered"
                               x-model.number="settings.min_booking_notice_hours"
                               min="1" max="168"
                               @change="saveSettings()">
                        <label class="label">
                            <span class="label-text-alt">How far in advance students must book</span>
                        </label>
                    </div>

                    <!-- Max Days Ahead -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-medium">Booking Window (days)</span>
                        </label>
                        <input type="number" class="input input-bordered"
                               x-model.number="settings.max_booking_days_ahead"
                               min="7" max="365"
                               @change="saveSettings()">
                        <label class="label">
                            <span class="label-text-alt">How far ahead students can book</span>
                        </label>
                    </div>

                    <!-- Auto Approve -->
                    <div class="form-control md:col-span-2 lg:col-span-3">
                        <label class="label cursor-pointer justify-start gap-2">
                            <input type="checkbox" class="checkbox checkbox-primary"
                                   x-model="settings.auto_approve_bookings"
                                   @change="saveSettings()">
                            <span class="label-text font-medium">Auto-approve bookings (students can book instantly within your availability)</span>
                        </label>
                    </div>
                </div>
            </template>

            <template x-if="!settings.use_availability_calendar">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    <span>Enable the availability calendar to allow students to book lessons directly from your schedule. When disabled, students submit requests that you approve manually.</span>
                </div>
            </template>
        </div>
    </div>

    <!-- Weekly Availability Section -->
    <template x-if="settings.use_availability_calendar">
        <div class="card card-section shadow-xl mb-6">
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="card-title text-2xl">Weekly Availability</h2>
                    <div class="flex gap-2">
                        <button class="btn btn-sm btn-outline" @click="clearAllSlots()">
                            <i class="fas fa-trash mr-2"></i>Clear All
                        </button>
                        <button class="btn btn-sm btn-section-primary" @click="saveWeeklyAvailability()">
                            <i class="fas fa-save mr-2"></i>Save Schedule
                        </button>
                    </div>
                </div>

                <p class="text-base-content/70 mb-6">Click and drag to add availability blocks. Click a block to remove it.</p>

                <!-- Weekly Grid -->
                <div class="overflow-x-auto">
                    <div class="min-w-[800px]">
                        <!-- Days Header -->
                        <div class="grid gap-2 mb-2" style="grid-template-columns: 80px repeat(7, 1fr);">
                            <div class="text-center font-bold text-sm">Time</div>
                            <template x-for="day in days" :key="day">
                                <div class="text-center font-bold text-sm" x-text="day"></div>
                            </template>
                        </div>

                        <!-- Time Slots Grid -->
                        <div class="space-y-1">
                            <template x-for="hour in timeSlots" :key="hour">
                                <div class="grid gap-2" style="grid-template-columns: 80px repeat(7, 1fr);">
                                    <!-- Time Label -->
                                    <div class="flex items-center justify-end pr-2 text-sm font-medium">
                                        <span x-text="formatTime(hour)"></span>
                                    </div>

                                    <!-- Day Cells -->
                                    <template x-for="(day, dayIndex) in days" :key="dayIndex">
                                        <div class="relative">
                                            <button
                                                class="w-full h-12 rounded border-2 transition-all"
                                                :class="isSlotSelected(dayIndex, hour) ? 'bg-primary border-primary text-primary-content' : 'bg-base-200 border-base-300 hover:border-primary'"
                                                @click="toggleSlot(dayIndex, hour)"
                                                @mousedown="startDrag(dayIndex, hour)"
                                                @mouseenter="continueDrag(dayIndex, hour)"
                                                @mouseup="endDrag()">
                                            </button>
                                        </div>
                                    </template>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>

                <!-- Summary -->
                <div class="mt-4 p-4 bg-base-200 rounded-lg">
                    <h3 class="font-bold mb-2">Availability Summary</h3>
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-2">
                        <template x-for="(day, dayIndex) in days" :key="dayIndex">
                            <div>
                                <div class="font-semibold text-sm" x-text="day"></div>
                                <div class="text-xs text-base-content/70">
                                    <template x-for="range in getDayRanges(dayIndex)" :key="range">
                                        <div x-text="range"></div>
                                    </template>
                                    <template x-if="getDayRanges(dayIndex).length === 0">
                                        <div class="text-error">Not available</div>
                                    </template>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Exceptions Section -->
    <template x-if="settings.use_availability_calendar">
        <div class="card card-section shadow-xl mb-6">
            <div class="card-body">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="card-title text-2xl">Exceptions & Blocks</h2>
                    <button class="btn btn-sm btn-section-primary" @click="showExceptionForm = !showExceptionForm">
                        <i class="fas fa-plus mr-2"></i>Add Exception
                    </button>
                </div>

                <p class="text-base-content/70 mb-4">Block specific dates or add special availability outside your regular schedule</p>

                <!-- Exception Form -->
                <template x-if="showExceptionForm">
                    <div class="p-4 bg-base-200 rounded-lg mb-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Type</span>
                                </label>
                                <select class="select select-bordered" x-model="newException.exception_type">
                                    <option value="blocked">Block Time</option>
                                    <option value="available">Special Hours</option>
                                </select>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Date</span>
                                </label>
                                <input type="date" class="input input-bordered" x-model="newException.date" required>
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">Start Time</span>
                                </label>
                                <input type="time" class="input input-bordered" x-model="newException.start_time">
                            </div>

                            <div class="form-control">
                                <label class="label">
                                    <span class="label-text font-medium">End Time</span>
                                </label>
                                <input type="time" class="input input-bordered" x-model="newException.end_time">
                            </div>

                            <div class="form-control md:col-span-2 lg:col-span-3">
                                <label class="label">
                                    <span class="label-text font-medium">Reason (optional)</span>
                                </label>
                                <input type="text" class="input input-bordered" x-model="newException.reason"
                                       placeholder="e.g., Holiday, Conference, etc.">
                            </div>

                            <div class="form-control flex justify-end">
                                <label class="label">
                                    <span class="label-text">&nbsp;</span>
                                </label>
                                <div class="flex gap-2">
                                    <button class="btn btn-sm btn-ghost" @click="cancelException()">Cancel</button>
                                    <button class="btn btn-sm btn-primary" @click="addException()">Add</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <!-- Exceptions List -->
                <div class="space-y-2">
                    <template x-for="exception in sortedExceptions" :key="exception.id">
                        <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="badge"
                                          :class="exception.exception_type === 'blocked' ? 'badge-error' : 'badge-success'">
                                        <i :class="exception.exception_type === 'blocked' ? 'fas fa-ban' : 'fas fa-clock'" class="mr-1"></i>
                                        <span x-text="exception.exception_type === 'blocked' ? 'Blocked' : 'Available'"></span>
                                    </span>
                                    <span class="font-semibold" x-text="formatDate(exception.date)"></span>
                                </div>
                                <div class="text-sm text-base-content/70">
                                    <span x-text="exception.start_time || 'All day'"></span>
                                    <template x-if="exception.end_time">
                                        <span> - <span x-text="exception.end_time"></span></span>
                                    </template>
                                    <template x-if="exception.reason">
                                        <span> • <span x-text="exception.reason"></span></span>
                                    </template>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-ghost btn-circle" @click="deleteException(exception.id)">
                                <i class="fas fa-trash text-error"></i>
                            </button>
                        </div>
                    </template>

                    <template x-if="exceptions.length === 0">
                        <div class="text-center py-8 text-base-content/50">
                            <i class="fas fa-calendar-alt text-4xl mb-2"></i>
                            <p>No exceptions added yet</p>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </template>

    <!-- Loading Indicator -->
    <template x-if="loading">
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
            <div class="bg-base-100 p-6 rounded-lg shadow-xl">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-4">Loading...</p>
            </div>
        </div>
    </template>
</div>

<script>
function availabilityEditor() {
    return {
        loading: true,
        teacherId: {{ teacher_id }},
        days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        timeSlots: [6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22],
        settings: {
            use_availability_calendar: false,
            buffer_minutes: 0,
            min_booking_notice_hours: 24,
            max_booking_days_ahead: 90,
            auto_approve_bookings: true
        },
        weeklySlots: {
            0: [], // Monday
            1: [],
            2: [],
            3: [],
            4: [],
            5: [],
            6: []  // Sunday
        },
        exceptions: [],
        showExceptionForm: false,
        newException: {
            exception_type: 'blocked',
            date: '',
            start_time: '',
            end_time: '',
            reason: ''
        },
        isDragging: false,
        dragMode: null, // 'add' or 'remove'

        async init() {
            await this.loadSettings();
            await this.loadWeeklyAvailability();
            await this.loadExceptions();
            this.loading = false;

            // Add mouseup listener to document for drag end
            document.addEventListener('mouseup', () => this.endDrag());
        },

        async loadSettings() {
            try {
                const response = await fetch('/private-teaching/api/availability-settings/my_settings/');
                if (response.ok) {
                    const data = await response.json();
                    this.settings = {
                        use_availability_calendar: data.use_availability_calendar,
                        buffer_minutes: data.buffer_minutes,
                        min_booking_notice_hours: data.min_booking_notice_hours,
                        max_booking_days_ahead: data.max_booking_days_ahead,
                        auto_approve_bookings: data.auto_approve_bookings
                    };
                }
            } catch (error) {
                console.error('Error loading settings:', error);
            }
        },

        async saveSettings() {
            try {
                const response = await fetch('/private-teaching/api/availability-settings/my_settings/', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(this.settings)
                });

                if (response.ok) {
                    this.showNotification('Settings saved successfully', 'success');
                } else {
                    this.showNotification('Error saving settings', 'error');
                }
            } catch (error) {
                console.error('Error saving settings:', error);
                this.showNotification('Error saving settings', 'error');
            }
        },

        async loadWeeklyAvailability() {
            try {
                const response = await fetch('/private-teaching/api/teacher-availability/');
                if (response.ok) {
                    const data = await response.json();
                    // Convert to our format
                    this.weeklySlots = {0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: []};
                    data.forEach(slot => {
                        if (!this.weeklySlots[slot.day_of_week]) {
                            this.weeklySlots[slot.day_of_week] = [];
                        }
                        this.weeklySlots[slot.day_of_week].push({
                            start_time: slot.start_time,
                            end_time: slot.end_time
                        });
                    });
                }
            } catch (error) {
                console.error('Error loading availability:', error);
            }
        },

        async saveWeeklyAvailability() {
            this.loading = true;
            try {
                // Convert our format to API format
                const payload = {};
                const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];

                for (let i = 0; i < 7; i++) {
                    payload[dayNames[i]] = this.weeklySlots[i].map(slot => ({
                        start: slot.start_time,
                        end: slot.end_time
                    }));
                }

                const response = await fetch('/private-teaching/api/teacher-availability/bulk_update/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    this.showNotification('Schedule saved successfully', 'success');
                } else {
                    this.showNotification('Error saving schedule', 'error');
                }
            } catch (error) {
                console.error('Error saving availability:', error);
                this.showNotification('Error saving schedule', 'error');
            } finally {
                this.loading = false;
            }
        },

        async loadExceptions() {
            try {
                const response = await fetch('/private-teaching/api/availability-exceptions/');
                if (response.ok) {
                    this.exceptions = await response.json();
                }
            } catch (error) {
                console.error('Error loading exceptions:', error);
            }
        },

        async addException() {
            if (!this.newException.date) {
                alert('Please select a date');
                return;
            }

            this.loading = true;
            try {
                const response = await fetch('/private-teaching/api/availability-exceptions/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': this.getCsrfToken()
                    },
                    body: JSON.stringify(this.newException)
                });

                if (response.ok) {
                    const exception = await response.json();
                    this.exceptions.push(exception);
                    this.cancelException();
                    this.showNotification('Exception added successfully', 'success');
                } else {
                    // Extract error message from response
                    const errorData = await response.json();
                    let errorMessage = 'Error adding exception';

                    if (errorData.non_field_errors) {
                        errorMessage = errorData.non_field_errors[0];
                    } else if (errorData.detail) {
                        errorMessage = errorData.detail;
                    } else {
                        // Check for field-specific errors
                        const fieldErrors = Object.values(errorData).filter(v => Array.isArray(v));
                        if (fieldErrors.length > 0) {
                            errorMessage = fieldErrors[0][0];
                        }
                    }

                    this.showNotification(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error adding exception:', error);
                this.showNotification('Error adding exception', 'error');
            } finally {
                this.loading = false;
            }
        },

        async deleteException(id) {
            if (!confirm('Are you sure you want to delete this exception?')) return;

            this.loading = true;
            try {
                const response = await fetch(`/private-teaching/api/availability-exceptions/${id}/`, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': this.getCsrfToken()
                    }
                });

                if (response.ok) {
                    this.exceptions = this.exceptions.filter(e => e.id !== id);
                    this.showNotification('Exception deleted successfully', 'success');
                } else {
                    this.showNotification('Error deleting exception', 'error');
                }
            } catch (error) {
                console.error('Error deleting exception:', error);
                this.showNotification('Error deleting exception', 'error');
            } finally {
                this.loading = false;
            }
        },

        cancelException() {
            this.showExceptionForm = false;
            this.newException = {
                exception_type: 'blocked',
                date: '',
                start_time: '',
                end_time: '',
                reason: ''
            };
        },

        isSlotSelected(dayIndex, hour) {
            const timeStr = this.formatTimeForApi(hour);
            return this.weeklySlots[dayIndex].some(slot => {
                const slotStart = slot.start_time.substring(0, 5);
                const slotEnd = slot.end_time.substring(0, 5);
                return timeStr >= slotStart && timeStr < slotEnd;
            });
        },

        toggleSlot(dayIndex, hour) {
            const timeStr = this.formatTimeForApi(hour);
            const endTimeStr = this.formatTimeForApi(hour + 1);

            // Check if this hour is already selected (within any slot)
            const existingSlotIndex = this.weeklySlots[dayIndex].findIndex(slot => {
                const slotStart = slot.start_time.substring(0, 5);
                const slotEnd = slot.end_time.substring(0, 5);
                return timeStr >= slotStart && timeStr < slotEnd;
            });

            if (existingSlotIndex !== -1) {
                // Remove or split the slot
                const slot = this.weeklySlots[dayIndex][existingSlotIndex];
                const slotStart = slot.start_time.substring(0, 5);
                const slotEnd = slot.end_time.substring(0, 5);

                // If clicking on a 1-hour slot, just remove it
                if (slotStart === timeStr && endTimeStr === slotEnd) {
                    this.weeklySlots[dayIndex].splice(existingSlotIndex, 1);
                } else if (slotStart === timeStr) {
                    // Clicking on first hour of multi-hour slot - remove first hour
                    slot.start_time = endTimeStr + ':00';
                } else if (endTimeStr === slotEnd) {
                    // Clicking on last hour of multi-hour slot - remove last hour
                    slot.end_time = timeStr + ':00';
                } else {
                    // Clicking in middle - split into two slots
                    const newSlot = {
                        start_time: endTimeStr + ':00',
                        end_time: slot.end_time
                    };
                    slot.end_time = timeStr + ':00';
                    this.weeklySlots[dayIndex].push(newSlot);
                }
            } else {
                // Add new slot
                this.weeklySlots[dayIndex].push({
                    start_time: timeStr + ':00',
                    end_time: endTimeStr + ':00'
                });
                // Sort and merge overlapping slots
                this.mergeSlots(dayIndex);
            }
        },

        startDrag(dayIndex, hour) {
            this.isDragging = true;
            this.dragMode = this.isSlotSelected(dayIndex, hour) ? 'remove' : 'add';
            this.toggleSlot(dayIndex, hour);
        },

        continueDrag(dayIndex, hour) {
            if (!this.isDragging) return;

            const isSelected = this.isSlotSelected(dayIndex, hour);
            if (this.dragMode === 'add' && !isSelected) {
                this.toggleSlot(dayIndex, hour);
            } else if (this.dragMode === 'remove' && isSelected) {
                this.toggleSlot(dayIndex, hour);
            }
        },

        endDrag() {
            this.isDragging = false;
            this.dragMode = null;
        },

        mergeSlots(dayIndex) {
            const slots = this.weeklySlots[dayIndex];
            if (slots.length <= 1) return;

            // Sort by start time
            slots.sort((a, b) => a.start_time.localeCompare(b.start_time));

            // Merge overlapping or adjacent slots
            const merged = [slots[0]];
            for (let i = 1; i < slots.length; i++) {
                const current = slots[i];
                const last = merged[merged.length - 1];

                if (current.start_time <= last.end_time) {
                    // Merge
                    last.end_time = current.end_time > last.end_time ? current.end_time : last.end_time;
                } else {
                    merged.push(current);
                }
            }

            this.weeklySlots[dayIndex] = merged;
        },

        clearAllSlots() {
            if (!confirm('Are you sure you want to clear all availability?')) return;
            this.weeklySlots = {0: [], 1: [], 2: [], 3: [], 4: [], 5: [], 6: []};
        },

        getDayRanges(dayIndex) {
            return this.weeklySlots[dayIndex].map(slot => {
                const start = slot.start_time.substring(0, 5);
                const end = slot.end_time.substring(0, 5);
                return `${start} - ${end}`;
            });
        },

        formatTime(hour) {
            const period = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour > 12 ? hour - 12 : (hour === 0 ? 12 : hour);
            return `${displayHour}:00 ${period}`;
        },

        formatTimeForApi(hour) {
            return hour.toString().padStart(2, '0') + ':00';
        },

        formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        },

        get sortedExceptions() {
            return [...this.exceptions].sort((a, b) => a.date.localeCompare(b.date));
        },

        getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                   document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];
        },

        showNotification(message, type) {
            // Simple notification - could be enhanced with a toast library
            const color = type === 'success' ? 'alert-success' : 'alert-error';
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert ${color} fixed top-4 right-4 w-auto z-50 shadow-lg`;
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 3000);
        }
    }
}
</script>
{% endblock %}
