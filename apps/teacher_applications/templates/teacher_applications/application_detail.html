{% extends 'admin_portal/base.html' %}

{% block title %}{{ application.name }} - Teacher Application{% endblock %}
{% block page_title %}Teacher Application Details{% endblock %}

{% block content %}

    <!-- Back Button -->
    <div class="mb-4">
        <a href="{% url 'admin_portal:applications:list' %}" class="btn btn-sm btn-ghost">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Applications
        </a>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Application Details -->
        <div class="lg:col-span-2 space-y-6">
            <!-- Applicant Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title flex items-center gap-2">
                        <i class="fas fa-user text-primary"></i>
                        Applicant Information
                    </h2>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                        <div>
                            <div class="text-sm font-semibold text-base-content/60">Full Name</div>
                            <div class="text-lg">{{ application.name }}</div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60">Email</div>
                            <div>{{ application.email }}</div>
                        </div>

                        {% if application.phone %}
                        <div>
                            <div class="text-sm font-semibold text-base-content/60">Phone</div>
                            <div>{{ application.phone }}</div>
                        </div>
                        {% endif %}

                        <div>
                            <div class="text-sm font-semibold text-base-content/60">Account Status</div>
                            <div>
                                {% if application.user %}
                                    <span class="badge badge-success">Has Platform Account</span>
                                {% else %}
                                    <span class="badge badge-ghost">No Account</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Teaching Information -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title flex items-center gap-2">
                        <i class="fas fa-chalkboard-teacher text-primary"></i>
                        Teaching Information
                    </h2>

                    <div class="space-y-4 mt-4">
                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">Subjects</div>
                            <div>{{ application.subjects }}</div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">Teaching Biography & Experience</div>
                            <div class="whitespace-pre-wrap bg-base-200 p-4 rounded">{{ application.teaching_biography }}</div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">Qualifications</div>
                            <div class="whitespace-pre-wrap bg-base-200 p-4 rounded">{{ application.qualifications }}</div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">DBS Check Status</div>
                            <div>
                                <span class="badge badge-outline">{{ application.get_dbs_check_status_display }}</span>
                            </div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">Preferred Teaching Format</div>
                            <div class="flex gap-2">
                                {% for format in application.get_teaching_formats_list %}
                                    <span class="badge badge-primary">{{ format }}</span>
                                {% endfor %}
                            </div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-base-content/60 mb-2">Availability</div>
                            <div class="whitespace-pre-wrap bg-base-200 p-4 rounded">{{ application.availability }}</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin Notes -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h2 class="card-title flex items-center gap-2">
                        <i class="fas fa-sticky-note text-primary"></i>
                        Admin Notes
                        <span class="text-xs text-base-content/60">(Internal only)</span>
                    </h2>

                    <form method="post" action="{% url 'admin_portal:applications:update_notes' application.id %}" class="mt-4">
                        {% csrf_token %}
                        <textarea name="admin_notes" class="textarea textarea-bordered w-full" rows="4"
                                  placeholder="Add internal notes about this application...">{{ application.admin_notes }}</textarea>
                        <button type="submit" class="btn btn-sm btn-primary mt-2">
                            <i class="fas fa-save mr-2"></i>
                            Save Notes
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar: Status & Actions -->
        <div class="space-y-6">
            <!-- Status Card -->
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="font-bold mb-4">Application Status</h3>

                    <div class="space-y-3">
                        <div>
                            <div class="text-sm text-base-content/60">Current Status</div>
                            <div class="mt-1">
                                {% if application.status == 'pending' %}
                                    <div class="badge badge-warning badge-lg">Pending Review</div>
                                {% elif application.status == 'approved' %}
                                    <div class="badge badge-success badge-lg">Approved</div>
                                {% elif application.status == 'rejected' %}
                                    <div class="badge badge-error badge-lg">Rejected</div>
                                {% else %}
                                    <div class="badge badge-info badge-lg">On Hold</div>
                                {% endif %}
                            </div>
                        </div>

                        <div>
                            <div class="text-sm text-base-content/60">Submitted</div>
                            <div>{{ application.created_at|date:"M d, Y" }}</div>
                            <div class="text-xs text-base-content/60">{{ application.created_at|timesince }} ago</div>
                        </div>

                        {% if application.reviewed_by %}
                        <div>
                            <div class="text-sm text-base-content/60">Reviewed By</div>
                            <div>{{ application.reviewed_by.get_full_name }}</div>
                            <div class="text-xs text-base-content/60">{{ application.reviewed_at|date:"M d, Y" }}</div>
                        </div>
                        {% endif %}

                        {% if application.rejection_reason %}
                        <div>
                            <div class="text-sm text-base-content/60">Rejection Reason</div>
                            <div class="text-sm bg-base-200 p-2 rounded mt-1">{{ application.rejection_reason }}</div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Actions Card -->
            {% if application.status == 'pending' %}
            <div class="card bg-base-100 shadow-xl">
                <div class="card-body">
                    <h3 class="font-bold mb-4">Actions</h3>

                    <!-- Approve Button -->
                    <form method="post" action="{% url 'admin_portal:applications:approve' application.id %}"
                          onsubmit="return confirm('Are you sure you want to approve this application? {% if application.user %}Teacher status will be granted to their account.{% else %}The applicant will be notified to create an account.{% endif %}');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success btn-block mb-2">
                            <i class="fas fa-check-circle mr-2"></i>
                            Approve Application
                        </button>
                    </form>

                    <!-- Put on Hold Button -->
                    <form method="post" action="{% url 'admin_portal:applications:on_hold' application.id %}"
                          onsubmit="return confirm('Put this application on hold? You can review it later.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-info btn-block mb-2">
                            <i class="fas fa-pause-circle mr-2"></i>
                            Put On Hold
                        </button>
                    </form>

                    <!-- Reject Button (opens modal) -->
                    <button onclick="reject_modal.showModal()" class="btn btn-error btn-block">
                        <i class="fas fa-times-circle mr-2"></i>
                        Reject Application
                    </button>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Rejection Modal -->
    <dialog id="reject_modal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg mb-4">Reject Application</h3>

            <form method="post" action="{% url 'admin_portal:applications:reject' application.id %}">
                {% csrf_token %}

                <div class="form-control">
                    <label class="label">
                        <span class="label-text font-semibold">Rejection Reason</span>
                    </label>
                    <textarea name="rejection_reason" class="textarea textarea-bordered" rows="4"
                              placeholder="Please provide a reason for rejection. This will be sent to the applicant."
                              required></textarea>
                    <label class="label">
                        <span class="label-text-alt">This reason will be included in the rejection email.</span>
                    </label>
                </div>

                <div class="modal-action">
                    <button type="button" class="btn btn-ghost" onclick="reject_modal.close()">Cancel</button>
                    <button type="submit" class="btn btn-error">
                        <i class="fas fa-times-circle mr-2"></i>
                        Confirm Rejection
                    </button>
                </div>
            </form>
        </div>
        <form method="dialog" class="modal-backdrop">
            <button>close</button>
        </form>
    </dialog>

{% endblock %}
