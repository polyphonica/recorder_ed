{% extends 'base.html' %}
{% load static %}

{% block title %}{{ quiz.title }} - {{ lesson.lesson_title }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" type="text/css" href="{% static 'css/ckeditor_custom.css' %}">
{% endblock %}

{% block content %}
<div class="section-courses min-h-screen bg-base-100">
    <!-- Breadcrumb -->
    <div class="breadcrumbs text-sm px-4 py-2 bg-base-200">
        <ul>
            <li><a href="{% url 'domain_selector' %}">Home</a></li>
            <li><a href="{% url 'courses:student_dashboard' %}">My Courses</a></li>
            <li><a href="{% url 'courses:detail' course.slug %}">{{ course.title }}</a></li>
            <li><a href="{% url 'courses:view_lesson' lesson.id %}">{{ lesson.lesson_title }}</a></li>
            <li>{{ quiz.title }}</li>
        </ul>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Quiz Header -->
        <div class="mb-6">
            <h1 class="text-4xl font-bold mb-2">
                <i class="fas fa-clipboard-question text-primary mr-2"></i>
                {{ quiz.title }}
            </h1>
            {% if quiz.description %}
                <p class="text-base-content/70 text-lg">{{ quiz.description }}</p>
            {% endif %}
        </div>

        <!-- Quiz Info Card -->
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="badge badge-lg badge-primary">
                        <i class="fas fa-list mr-2"></i>
                        {{ questions.count }} Question{{ questions.count|pluralize }}
                    </div>
                    <div class="badge badge-lg badge-accent">
                        <i class="fas fa-trophy mr-2"></i>
                        Pass: {{ quiz.pass_percentage }}%
                    </div>
                    <div class="badge badge-lg badge-info">
                        <i class="fas fa-redo mr-2"></i>
                        Unlimited Attempts
                    </div>
                </div>

                {% if best_attempt %}
                    <div class="alert alert-success mt-4">
                        <i class="fas fa-check-circle"></i>
                        <div>
                            <div class="font-bold">Best Score: {{ best_attempt.score }}%</div>
                            <div class="text-sm">You've already passed! You can retake to improve your score.</div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Previous Attempts -->
        {% if previous_attempts %}
        <div class="card bg-base-100 shadow-xl mb-6">
            <div class="card-body">
                <h2 class="card-title">
                    <i class="fas fa-history mr-2"></i>
                    Recent Attempts
                </h2>
                <div class="overflow-x-auto">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Score</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for attempt in previous_attempts %}
                            <tr>
                                <td>{{ attempt.submitted_at|date:"M d, Y g:i A" }}</td>
                                <td>{{ attempt.score }}%</td>
                                <td>
                                    {% if attempt.passed %}
                                        <span class="badge badge-success badge-sm">Passed</span>
                                    {% else %}
                                        <span class="badge badge-error badge-sm">Failed</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quiz Form -->
        <form id="quizForm">
            {% for question in questions %}
            <div class="card bg-base-100 shadow-xl mb-6">
                <div class="card-body">
                    <h3 class="card-title text-lg">
                        <span class="badge badge-primary mr-2">Q{{ forloop.counter }}</span>
                        <div class="prose max-w-none ck-content">{{ question.text|safe }}</div>
                    </h3>

                    <div class="form-control mt-4 space-y-2">
                        {% for answer in question.answers.all %}
                        <label class="flex items-start gap-3 p-4 rounded-lg border border-base-300 hover:bg-base-200 cursor-pointer transition-colors">
                            <input type="radio"
                                   name="question_{{ question.id }}"
                                   value="{{ answer.id }}"
                                   class="radio radio-primary mt-1 flex-shrink-0"
                                   required>
                            <span class="text-base flex-1">{{ answer.text }}</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Submit Button -->
            <div class="flex justify-between items-center mt-8">
                <a href="{% url 'courses:view_lesson' lesson.id %}"
                   class="btn btn-outline">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Lesson
                </a>

                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                    <i class="fas fa-paper-plane mr-2"></i>Submit Quiz
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Result Modal -->
<dialog id="resultModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-2xl mb-4" id="resultTitle">Quiz Results</h3>

        <div class="text-center py-6" id="resultContent">
            <div class="text-6xl mb-4" id="resultIcon"></div>
            <div class="text-4xl font-bold mb-2" id="resultScore"></div>
            <div class="text-lg" id="resultMessage"></div>
        </div>

        <div class="modal-action">
            <button onclick="window.location.href=document.getElementById('lessonLink').href"
                    class="btn btn-primary">
                <i class="fas fa-arrow-left mr-2"></i>
                <span id="backButtonText">Back to Lesson</span>
            </button>
            <button onclick="location.reload()"
                    class="btn btn-outline">
                <i class="fas fa-redo mr-2"></i>Try Again
            </button>
        </div>
        <a id="lessonLink" href="{% url 'courses:view_lesson' lesson.id %}" style="display:none;"></a>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
document.getElementById('quizForm').addEventListener('submit', function(e) {
    e.preventDefault();

    // Disable submit button
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="loading loading-spinner"></span> Submitting...';

    // Collect answers
    const answers = {};
    const formData = new FormData(e.target);

    for (let [key, value] of formData.entries()) {
        // Extract question ID from input name (question_UUID)
        const questionId = key.replace('question_', '');
        answers[questionId] = value;
    }

    // Submit quiz
    fetch('{% url "courses:submit_quiz" lesson.id %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answers: answers })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showResult(data);
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Quiz';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while submitting the quiz.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Submit Quiz';
    });
});

function showResult(data) {
    const modal = document.getElementById('resultModal');
    const icon = document.getElementById('resultIcon');
    const score = document.getElementById('resultScore');
    const message = document.getElementById('resultMessage');
    const backButton = document.getElementById('backButtonText');

    if (data.passed) {
        icon.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
        score.textContent = data.score + '%';
        message.textContent = 'Congratulations! You passed the quiz!';
        backButton.textContent = 'Continue to Next Lesson';
    } else {
        icon.innerHTML = '<i class="fas fa-times-circle text-error"></i>';
        score.textContent = data.score + '%';
        message.textContent = 'You need ' + data.pass_percentage + '% to pass. Try again!';
        backButton.textContent = 'Back to Lesson';
    }

    modal.showModal();
}
</script>
{% endblock %}
