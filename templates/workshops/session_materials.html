{% extends "base.html" %}

{% block title %}Manage Materials - {{ session.workshop.title }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="breadcrumbs text-sm">
            <ul>
                <li><a href="{% url 'workshops:instructor_dashboard' %}">Instructor Dashboard</a></li>
                <li><a href="{% url 'workshops:instructor_workshops' %}">My Workshops</a></li>
                <li><a href="{% url 'workshops:manage_sessions' workshop.slug %}">{{ workshop.title }}</a></li>
                <li>Session Materials</li>
            </ul>
        </div>
        
        <h1 class="text-3xl font-bold text-gray-900 mt-4">
            Session Materials
        </h1>
        <p class="text-lg text-gray-600 mt-2">
            {{ session.workshop.title }} - {{ session.start_datetime|date:"M j, Y g:i A" }}
        </p>
    </div>

    <!-- Session Info Card -->
    <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body">
            <h2 class="card-title">Session Information</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                <div>
                    <div class="stat">
                        <div class="stat-title">Date & Time</div>
                        <div class="stat-value text-lg">{{ session.start_datetime|date:"M j" }}</div>
                        <div class="stat-desc">{{ session.start_datetime|time:"g:i A" }} - {{ session.end_datetime|time:"g:i A" }}</div>
                    </div>
                </div>
                <div>
                    <div class="stat">
                        <div class="stat-title">Registrations</div>
                        <div class="stat-value text-lg">{{ session.current_registrations }}/{{ session.max_participants }}</div>
                        <div class="stat-desc">{{ session.registrations.count }} total registered</div>
                    </div>
                </div>
                <div>
                    <div class="stat">
                        <div class="stat-title">Materials</div>
                        <div class="stat-value text-lg">{{ materials.count }}</div>
                        <div class="stat-desc">Files uploaded</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Upload New Material -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Upload New Material</h2>
                
                <p class="text-base-content/70 text-sm mb-4">
                    Upload handouts, slides, code samples, or any other materials for your participants.
                </p>

                <a href="{% url 'workshops:create_session_material' session.id %}" class="btn btn-primary w-full">
                    <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM6.293 6.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L11 5.414V13a1 1 0 11-2 0V5.414L7.707 6.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path>
                    </svg>
                    Upload Material
                </a>
                
                <div class="alert alert-info mt-4">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold">Material Access Control</h3>
                        <div class="text-sm mt-1">
                            <strong>Before Session:</strong> Available for download before the session starts<br>
                            <strong>During Session:</strong> Only available while session is running<br>
                            <strong>After Session:</strong> Available after session ends<br>
                            <strong>Always:</strong> Available to registered participants anytime
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Current Materials -->
        <div class="card bg-base-100 shadow-xl">
            <div class="card-body">
                <h2 class="card-title">Current Materials ({{ materials.count }})</h2>
                
                {% if materials %}
                    <div class="space-y-3 mt-4">
                        {% for material in materials %}
                            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="avatar placeholder">
                                        <div class="bg-primary text-primary-content rounded w-10 h-10">
                                            <span class="text-xs">
                                                {% if material.material_type == 'slides' %}üìä
                                                {% elif material.material_type == 'handout' %}üìÑ
                                                {% elif material.material_type == 'code' %}üíª
                                                {% elif material.material_type == 'recording' %}üé•
                                                {% elif material.material_type == 'link' %}üîó
                                                {% else %}üìÅ{% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    <div>
                                        <div class="font-semibold">{{ material.title }}</div>
                                        <div class="text-sm text-base-content/70">
                                            {{ material.get_material_type_display }} ‚Ä¢ 
                                            {{ material.get_access_timing_display }}
                                            {% if material.file %}
                                                ‚Ä¢ {{ material.file_size_display }}
                                            {% endif %}
                                        </div>
                                        {% if material.description %}
                                            <div class="text-xs text-base-content/60 mt-1">{{ material.description|truncatechars:100 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="flex space-x-2">
                                    {% if material.file %}
                                        <a href="{% url 'workshops:material_download' material.id %}" 
                                           class="btn btn-sm btn-outline" target="_blank">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                            </svg>
                                        </a>
                                    {% elif material.external_url %}
                                        <a href="{{ material.external_url }}" 
                                           class="btn btn-sm btn-outline" target="_blank">
                                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                                <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z"></path>
                                                <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z"></path>
                                            </svg>
                                        </a>
                                    {% endif %}
                                    <a href="{% url 'workshops:edit_session_material' material.id %}" 
                                       class="btn btn-sm btn-ghost">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"></path>
                                        </svg>
                                    </a>
                                    <button onclick="confirmDelete('{{ material.id }}', '{{ material.title|escapejs }}')" 
                                            class="btn btn-sm btn-error btn-outline">
                                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path>
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414L9.586 12l-2.293 2.293a1 1 0 101.414 1.414L12 13.414l2.293 2.293a1 1 0 001.414-1.414L13.414 12l2.293-2.293z" clip-rule="evenodd"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-8">
                        <div class="text-6xl mb-4">üìÅ</div>
                        <p class="text-base-content/70">No materials uploaded yet</p>
                        <p class="text-sm text-base-content/60 mt-2">
                            Upload handouts, slides, or other materials for your participants
                        </p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
        <!-- Quick Actions -->
    <div class="mt-8 flex flex-wrap gap-4">
        <a href="{% url 'workshops:manage_sessions' workshop.slug %}" class="btn btn-outline">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M7.707 14.707a1 1 0 01-1.414 0L2.586 11l3.707-3.707a1 1 0 011.414 1.414L5.414 11l2.293 2.293a1 1 0 010 1.414z" clip-rule="evenodd"></path>
            </svg>
            Back to Sessions
        </a>
        <a href="{% url 'workshops:session_registrations' session.id %}" class="btn btn-secondary">
            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"></path>
            </svg>
            View Participants ({{ session.current_registrations }})
        </a>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Confirm Delete</h3>
        <p class="py-4">Are you sure you want to delete <span id="materialName" class="font-semibold"></span>?</p>
        <p class="text-sm text-base-content/70 mb-4">This action cannot be undone. Participants will immediately lose access to this material.</p>
        <div class="modal-action">
            <button onclick="closeDeleteModal()" class="btn">Cancel</button>
            <form id="deleteForm" method="post" class="inline">
                {% csrf_token %}
                <button type="submit" class="btn btn-error">Delete Material</button>
            </form>
        </div>
    </div>
</div>

<script>
function confirmDelete(materialId, materialTitle) {
    document.getElementById('materialName').textContent = materialTitle;
    // Build the URL manually since Django template tags don't handle placeholders well
    const deleteUrl = '/workshops/instructor/session/{{ session.id }}/material/' + materialId + '/delete/';
    document.getElementById('deleteForm').action = deleteUrl;
    document.getElementById('deleteModal').classList.add('modal-open');
}

function closeDeleteModal() {
    document.getElementById('deleteModal').classList.remove('modal-open');
}
</script>
{% endblock %}