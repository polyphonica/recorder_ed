{% extends 'base.html' %}
{% load static %}

{% block title %}{{ viewed_student.get_full_name }}'s Practice Log{% endblock %}

{% block content %}
<div class="min-h-screen bg-base-100">
    <!-- Breadcrumb -->
    <div class="breadcrumbs text-sm px-4 py-2 bg-base-200">
        <ul>
            <li><a href="{% url 'private_teaching:home' %}">Private Teaching</a></li>
            <li><a href="{% url 'private_teaching:teacher_dashboard' %}">Teacher Dashboard</a></li>
            <li><a href="{% url 'private_teaching:teacher_students' %}">Students</a></li>
            <li>{{ viewed_student.get_full_name }}'s Practice Log</li>
        </ul>
    </div>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="mb-6">
            <h1 class="text-4xl font-bold">{{ viewed_student.get_full_name }}'s Practice Log</h1>
            <p class="text-base-content/70 mt-2">View and comment on student practice sessions</p>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
            <!-- Total Sessions -->
            <div class="card bg-primary text-primary-content">
                <div class="card-body">
                    <h2 class="card-title text-sm opacity-90">Total Sessions</h2>
                    <p class="text-3xl font-bold">{{ total_sessions }}</p>
                </div>
            </div>

            <!-- Total Time -->
            <div class="card bg-secondary text-secondary-content">
                <div class="card-body">
                    <h2 class="card-title text-sm opacity-90">Total Practice Time</h2>
                    <p class="text-3xl font-bold">{{ total_hours }}h</p>
                    <p class="text-sm opacity-75">{{ total_minutes }} minutes</p>
                </div>
            </div>

            <!-- Last Week -->
            <div class="card bg-accent text-accent-content">
                <div class="card-body">
                    <h2 class="card-title text-sm opacity-90">Last 7 Days</h2>
                    <p class="text-3xl font-bold">{{ last_week_sessions }}</p>
                    <p class="text-sm opacity-75">{{ last_week_hours }}h practice</p>
                </div>
            </div>

            <!-- Average Enjoyment -->
            <div class="card bg-success text-success-content">
                <div class="card-body">
                    <h2 class="card-title text-sm opacity-90">Avg Enjoyment</h2>
                    <p class="text-3xl font-bold">
                        {% if avg_enjoyment %}
                            {{ avg_enjoyment }}/5
                            <i class="fas fa-star text-yellow-300 text-xl ml-1"></i>
                        {% else %}
                            -
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

        <!-- Exam/Performance Stats -->
        {% if exam_prep_count or performance_prep_count %}
            <div class="alert alert-success mb-6">
                <i class="fas fa-trophy text-xl"></i>
                <div class="flex gap-6">
                    {% if exam_prep_count %}
                        <span><i class="fas fa-graduation-cap mr-2"></i>{{ exam_prep_count }} exam prep session{{ exam_prep_count|pluralize }}</span>
                    {% endif %}
                    {% if performance_prep_count %}
                        <span><i class="fas fa-music mr-2"></i>{{ performance_prep_count }} performance prep session{{ performance_prep_count|pluralize }}</span>
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Filters -->
        <div class="card bg-base-200 mb-6">
            <div class="card-body">
                <h2 class="card-title text-lg mb-4">Filter Practice Entries</h2>
                <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <!-- Exam Prep Filter -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Exam Preparation</span>
                        </label>
                        <select name="exam_prep" class="select select-bordered select-sm">
                            <option value="">All</option>
                            <option value="yes" {% if exam_prep_filter == 'yes' %}selected{% endif %}>Exam Prep Only</option>
                        </select>
                    </div>

                    <!-- Performance Prep Filter -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Performance Prep</span>
                        </label>
                        <select name="performance_prep" class="select select-bordered select-sm">
                            <option value="">All</option>
                            <option value="yes" {% if performance_prep_filter == 'yes' %}selected{% endif %}>Performance Prep Only</option>
                        </select>
                    </div>

                    <div class="form-control flex flex-row gap-2 justify-end items-end">
                        <button type="submit" class="btn btn-primary btn-sm">
                            <i class="fas fa-filter mr-2"></i>
                            Apply Filters
                        </button>
                        <a href="{% url 'private_teaching:teacher_student_practice' student_id=viewed_student.id %}" class="btn btn-ghost btn-sm">
                            Clear Filters
                        </a>
                    </div>
                </form>
            </div>
        </div>

        <!-- Practice Entries List -->
        {% if practice_entries %}
            <div class="space-y-4">
                {% for entry in practice_entries %}
                    <div class="card bg-base-200 hover:shadow-lg transition">
                        <div class="card-body">
                            <div class="flex justify-between items-start">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-2">
                                        <h3 class="text-xl font-bold">{{ entry.practice_date|date:"F j, Y" }}</h3>
                                        <div class="badge badge-primary">{{ entry.duration_minutes }} min</div>
                                        {% if entry.preparing_for_exam %}
                                            <div class="badge badge-warning gap-1">
                                                <i class="fas fa-graduation-cap"></i>
                                                Exam Prep
                                            </div>
                                        {% endif %}
                                        {% if entry.preparing_for_performance %}
                                            <div class="badge badge-secondary gap-1">
                                                <i class="fas fa-music"></i>
                                                Performance Prep
                                            </div>
                                        {% endif %}
                                        {% if not entry.teacher_viewed_at %}
                                            <div class="badge badge-info gap-1">
                                                <i class="fas fa-bell"></i>
                                                New
                                            </div>
                                        {% endif %}
                                    </div>

                                    <div class="text-sm text-base-content/70 mb-3">
                                        {% if entry.child_profile %}
                                            <span><i class="fas fa-child mr-1"></i>{{ entry.child_profile.full_name }}</span>
                                        {% endif %}
                                        {% if entry.enjoyment_rating %}
                                            <span class="ml-4">
                                                <i class="fas fa-star mr-1 text-warning"></i>
                                                Enjoyment: {{ entry.enjoyment_rating }}/5
                                            </span>
                                        {% endif %}
                                        <span class="ml-4">
                                            <i class="fas fa-clock mr-1"></i>
                                            Logged {{ entry.created_at|timesince }} ago
                                        </span>
                                    </div>

                                    {% if entry.pieces_practiced %}
                                        <div class="mb-2">
                                            <span class="font-semibold text-sm">Pieces:</span>
                                            <p class="text-sm">{{ entry.pieces_practiced }}</p>
                                        </div>
                                    {% endif %}

                                    {% if entry.exercises_practiced %}
                                        <div class="mb-2">
                                            <span class="font-semibold text-sm">Exercises:</span>
                                            <p class="text-sm">{{ entry.exercises_practiced }}</p>
                                        </div>
                                    {% endif %}

                                    {% if entry.focus_areas %}
                                        <div class="mb-2">
                                            <span class="font-semibold text-sm">Focus:</span>
                                            <p class="text-sm">{{ entry.focus_areas }}</p>
                                        </div>
                                    {% endif %}

                                    {% if entry.achievements %}
                                        <div class="mb-2">
                                            <span class="font-semibold text-sm">Achievements:</span>
                                            <p class="text-sm text-success">{{ entry.achievements }}</p>
                                        </div>
                                    {% endif %}

                                    {% if entry.struggles %}
                                        <div class="mb-2">
                                            <span class="font-semibold text-sm">Struggles:</span>
                                            <p class="text-sm text-warning">{{ entry.struggles }}</p>
                                        </div>
                                    {% endif %}

                                    <!-- Teacher Comment Section -->
                                    {% if entry.teacher_comment %}
                                        <div class="alert alert-success mt-3">
                                            <i class="fas fa-comment"></i>
                                            <div>
                                                <p class="font-semibold text-sm">Your Comment:</p>
                                                <p class="text-sm">{{ entry.teacher_comment }}</p>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="collapse collapse-arrow bg-base-300 mt-3">
                                            <input type="checkbox" />
                                            <div class="collapse-title font-medium">
                                                <i class="fas fa-comment mr-2"></i>
                                                Add Teacher Comment
                                            </div>
                                            <div class="collapse-content">
                                                <form method="post" action="{% url 'private_teaching:add_practice_comment' entry_id=entry.id %}">
                                                    {% csrf_token %}
                                                    <div class="form-control">
                                                        <textarea
                                                            name="teacher_comment"
                                                            class="textarea textarea-bordered"
                                                            rows="3"
                                                            placeholder="Add encouraging feedback or suggestions..."
                                                            required
                                                        ></textarea>
                                                    </div>
                                                    <div class="flex justify-end mt-2">
                                                        <button type="submit" class="btn btn-success btn-sm">
                                                            <i class="fas fa-save mr-2"></i>
                                                            Add Comment
                                                        </button>
                                                    </div>
                                                </form>
                                            </div>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <!-- Pagination -->
            {% if is_paginated %}
                <div class="flex justify-center mt-8">
                    <div class="join">
                        {% if page_obj.has_previous %}
                            <a href="?page=1{% if exam_prep_filter %}&exam_prep={{ exam_prep_filter }}{% endif %}{% if performance_prep_filter %}&performance_prep={{ performance_prep_filter }}{% endif %}" class="join-item btn btn-sm">«</a>
                            <a href="?page={{ page_obj.previous_page_number }}{% if exam_prep_filter %}&exam_prep={{ exam_prep_filter }}{% endif %}{% if performance_prep_filter %}&performance_prep={{ performance_prep_filter }}{% endif %}" class="join-item btn btn-sm">‹</a>
                        {% endif %}

                        <button class="join-item btn btn-sm btn-active">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</button>

                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if exam_prep_filter %}&exam_prep={{ exam_prep_filter }}{% endif %}{% if performance_prep_filter %}&performance_prep={{ performance_prep_filter }}{% endif %}" class="join-item btn btn-sm">›</a>
                            <a href="?page={{ page_obj.paginator.num_pages }}{% if exam_prep_filter %}&exam_prep={{ exam_prep_filter }}{% endif %}{% if performance_prep_filter %}&performance_prep={{ performance_prep_filter }}{% endif %}" class="join-item btn btn-sm">»</a>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        {% else %}
            <div class="card bg-base-200">
                <div class="card-body text-center py-12">
                    <i class="fas fa-clipboard-list text-6xl text-base-content/20 mb-4"></i>
                    <h3 class="text-2xl font-bold mb-2">No Practice Entries Yet</h3>
                    <p class="text-base-content/70">This student hasn't logged any practice sessions yet.</p>
                </div>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}
